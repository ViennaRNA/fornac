!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("d3")):"function"==typeof define&&define.amd?define(["d3"],e):"object"==typeof exports?exports.fornac=e(require("d3")):t.fornac=e(t.d3)}(window,function(t){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(r,o,function(e){return t[e]}.bind(null,o));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=16)}([function(e,n){e.exports=t},function(t,e,n){t.exports={nodeStrokeWidth:"0.8",directionArrowSize:"6",directionArrowWidth:"0.7",node:"fornac-node",directionArrow:"fornac-directionArrow",plot:"fornac-plot",selectedNode:"fornac-selectedNode",nodeLabel:"fornac-nodeLabel",link:"fornac-link",plotLabel:"fornac-plotLabel",transparent:"fornac-transparent",dragLine:"fornac-dragLine",mouseEventHelper:"fornac-mouseEventHelper"}},function(t,e,n){t.exports=n(8)},function(t,e,n){"use strict";n.r(e),n.d(e,"Connection",function(){return i});var r=n(4),o=n(5);function i(){this.loop=new r.a,this.region=new o.a,this.start=null,this.end=null,this.xrad=null,this.yrad=null,this.angle=null,this.extruded=null,this.broken=null,this._isNull=!1}i.prototype.isNull=function(){return this._isNull},i.prototype.setNull=function(t){this._isNull=t},i.prototype.getLoop=function(){return this.loop},i.prototype.setLoop=function(t){this.loop=t},i.prototype.getRegion=function(){return this.region},i.prototype.setRegion=function(t){this.region=t},i.prototype.getStart=function(){return this.start},i.prototype.setStart=function(t){this.start=t},i.prototype.getEnd=function(){return this.end},i.prototype.setEnd=function(t){this.end=t},i.prototype.getXrad=function(){return this.xrad},i.prototype.setXrad=function(t){this.xrad=t},i.prototype.getYrad=function(){return this.yrad},i.prototype.setYrad=function(t){this.yrad=t},i.prototype.getAngle=function(){return this.angle},i.prototype.setAngle=function(t){this.angle=t},i.prototype.isExtruded=function(){return this.extruded},i.prototype.setExtruded=function(t){this.extruded=t},i.prototype.isBroken=function(){return this.broken},i.prototype.setBroken=function(t){this.broken=t}},function(t,e,n){"use strict";n.d(e,"a",function(){return o});var r=n(3);function o(){this.nconnection=null,this.connections=[],this._connections=[],this.number=null,this.depth=null,this.mark=null,this.x=null,this.y=null,this.radius=null}o.prototype.getNconnection=function(){return this.nconnection},o.prototype.setNconnection=function(t){this.nconnection=t},o.prototype.setConnection=function(t,e){null!=e?this._connections[t]=e:(this._connections[t]||(this._connections[t]=new r.Connection),this._connections[t].setNull(!0))},o.prototype.getConnection=function(t){var e=n(3);this._connections[t]||(this._connections[t]=new e);var r=this._connections[t];return r.isNull()?null:r},o.prototype.addConnection=function(t,e){this._connections.push(e)},o.prototype.getNumber=function(){return this.number},o.prototype.setNumber=function(t){this.number=t},o.prototype.getDepth=function(){return this.depth},o.prototype.setDepth=function(t){this.depth=t},o.prototype.isMark=function(){return this.mark},o.prototype.setMark=function(t){this.mark=t},o.prototype.getX=function(){return this.x},o.prototype.setX=function(t){this.x=t},o.prototype.getY=function(){return this.y},o.prototype.setY=function(t){this.y=t},o.prototype.getRadius=function(){return this.radius},o.prototype.setRadius=function(t){this.radius=t}},function(t,e,n){"use strict";function r(){this._start1=null,this._end1=null,this._start2=null,this._end2=null}n.d(e,"a",function(){return r}),r.prototype.getStart1=function(){return this._start1},r.prototype.setStart1=function(t){this._start1=t},r.prototype.getEnd1=function(){return this._end1},r.prototype.setEnd1=function(t){this._end1=t},r.prototype.getStart2=function(){return this._start2},r.prototype.setStart2=function(t){this._start2=t},r.prototype.getEnd2=function(){return this._end2},r.prototype.setEnd2=function(t){this._end2=t}},function(t,e){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(t){"object"==typeof window&&(n=window)}t.exports=n},function(t,e,n){t.exports=n.p+"fa9b45d63b40299e0188927ca7d381a3.svg"},function(t,e,n){(function(t){var r=n(13);e.encode=function(e){var n=r.parse(e);return new t(n).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").substring(0,22)},e.decode=function(e){var n=e.replace(/-/g,"+").replace(/_/g,"/")+"==";return r.unparse(new t(n,"base64"))},e.v4=function(){return r.v4(null,new t(16)).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").substring(0,22)},e.nice=function(){var e=r.v4(null,new t(16));return e[0]=127&e[0],e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").substring(0,22)}}).call(this,n(9).Buffer)},function(t,e,n){"use strict";(function(t){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */
var r=n(10),o=n(11),i=n(12);function s(){return u.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function a(t,e){if(s()<e)throw new RangeError("Invalid typed array length");return u.TYPED_ARRAY_SUPPORT?(t=new Uint8Array(e)).__proto__=u.prototype:(null===t&&(t=new u(e)),t.length=e),t}function u(t,e,n){if(!(u.TYPED_ARRAY_SUPPORT||this instanceof u))return new u(t,e,n);if("number"==typeof t){if("string"==typeof e)throw new Error("If encoding is specified then the first argument must be a string");return d(this,t)}return l(this,t,e,n)}function l(t,e,n,r){if("number"==typeof e)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer?function(t,e,n,r){if(e.byteLength,n<0||e.byteLength<n)throw new RangeError("'offset' is out of bounds");if(e.byteLength<n+(r||0))throw new RangeError("'length' is out of bounds");e=void 0===n&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,n):new Uint8Array(e,n,r);u.TYPED_ARRAY_SUPPORT?(t=e).__proto__=u.prototype:t=h(t,e);return t}(t,e,n,r):"string"==typeof e?function(t,e,n){"string"==typeof n&&""!==n||(n="utf8");if(!u.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var r=0|p(e,n),o=(t=a(t,r)).write(e,n);o!==r&&(t=t.slice(0,o));return t}(t,e,n):function(t,e){if(u.isBuffer(e)){var n=0|f(e.length);return 0===(t=a(t,n)).length?t:(e.copy(t,0,0,n),t)}if(e){if("undefined"!=typeof ArrayBuffer&&e.buffer instanceof ArrayBuffer||"length"in e)return"number"!=typeof e.length||(r=e.length)!=r?a(t,0):h(t,e);if("Buffer"===e.type&&i(e.data))return h(t,e.data)}var r;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(t,e)}function c(t){if("number"!=typeof t)throw new TypeError('"size" argument must be a number');if(t<0)throw new RangeError('"size" argument must not be negative')}function d(t,e){if(c(e),t=a(t,e<0?0:0|f(e)),!u.TYPED_ARRAY_SUPPORT)for(var n=0;n<e;++n)t[n]=0;return t}function h(t,e){var n=e.length<0?0:0|f(e.length);t=a(t,n);for(var r=0;r<n;r+=1)t[r]=255&e[r];return t}function f(t){if(t>=s())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s().toString(16)+" bytes");return 0|t}function p(t,e){if(u.isBuffer(t))return t.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(t)||t instanceof ArrayBuffer))return t.byteLength;"string"!=typeof t&&(t=""+t);var n=t.length;if(0===n)return 0;for(var r=!1;;)switch(e){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return D(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return q(t).length;default:if(r)return D(t).length;e=(""+e).toLowerCase(),r=!0}}function g(t,e,n){var r=t[e];t[e]=t[n],t[n]=r}function y(t,e,n,r,o){if(0===t.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=o?0:t.length-1),n<0&&(n=t.length+n),n>=t.length){if(o)return-1;n=t.length-1}else if(n<0){if(!o)return-1;n=0}if("string"==typeof e&&(e=u.from(e,r)),u.isBuffer(e))return 0===e.length?-1:m(t,e,n,r,o);if("number"==typeof e)return e&=255,u.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?o?Uint8Array.prototype.indexOf.call(t,e,n):Uint8Array.prototype.lastIndexOf.call(t,e,n):m(t,[e],n,r,o);throw new TypeError("val must be string, number or Buffer")}function m(t,e,n,r,o){var i,s=1,a=t.length,u=e.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(t.length<2||e.length<2)return-1;s=2,a/=2,u/=2,n/=2}function l(t,e){return 1===s?t[e]:t.readUInt16BE(e*s)}if(o){var c=-1;for(i=n;i<a;i++)if(l(t,i)===l(e,-1===c?0:i-c)){if(-1===c&&(c=i),i-c+1===u)return c*s}else-1!==c&&(i-=i-c),c=-1}else for(n+u>a&&(n=a-u),i=n;i>=0;i--){for(var d=!0,h=0;h<u;h++)if(l(t,i+h)!==l(e,h)){d=!1;break}if(d)return i}return-1}function v(t,e,n,r){n=Number(n)||0;var o=t.length-n;r?(r=Number(r))>o&&(r=o):r=o;var i=e.length;if(i%2!=0)throw new TypeError("Invalid hex string");r>i/2&&(r=i/2);for(var s=0;s<r;++s){var a=parseInt(e.substr(2*s,2),16);if(isNaN(a))return s;t[n+s]=a}return s}function b(t,e,n,r){return z(D(e,t.length-n),t,n,r)}function k(t,e,n,r){return z(function(t){for(var e=[],n=0;n<t.length;++n)e.push(255&t.charCodeAt(n));return e}(e),t,n,r)}function x(t,e,n,r){return k(t,e,n,r)}function w(t,e,n,r){return z(q(e),t,n,r)}function A(t,e,n,r){return z(function(t,e){for(var n,r,o,i=[],s=0;s<t.length&&!((e-=2)<0);++s)n=t.charCodeAt(s),r=n>>8,o=n%256,i.push(o),i.push(r);return i}(e,t.length-n),t,n,r)}function E(t,e,n){return 0===e&&n===t.length?r.fromByteArray(t):r.fromByteArray(t.slice(e,n))}function _(t,e,n){n=Math.min(t.length,n);for(var r=[],o=e;o<n;){var i,s,a,u,l=t[o],c=null,d=l>239?4:l>223?3:l>191?2:1;if(o+d<=n)switch(d){case 1:l<128&&(c=l);break;case 2:128==(192&(i=t[o+1]))&&(u=(31&l)<<6|63&i)>127&&(c=u);break;case 3:i=t[o+1],s=t[o+2],128==(192&i)&&128==(192&s)&&(u=(15&l)<<12|(63&i)<<6|63&s)>2047&&(u<55296||u>57343)&&(c=u);break;case 4:i=t[o+1],s=t[o+2],a=t[o+3],128==(192&i)&&128==(192&s)&&128==(192&a)&&(u=(15&l)<<18|(63&i)<<12|(63&s)<<6|63&a)>65535&&u<1114112&&(c=u)}null===c?(c=65533,d=1):c>65535&&(c-=65536,r.push(c>>>10&1023|55296),c=56320|1023&c),r.push(c),o+=d}return function(t){var e=t.length;if(e<=N)return String.fromCharCode.apply(String,t);var n="",r=0;for(;r<e;)n+=String.fromCharCode.apply(String,t.slice(r,r+=N));return n}(r)}e.Buffer=u,e.SlowBuffer=function(t){+t!=t&&(t=0);return u.alloc(+t)},e.INSPECT_MAX_BYTES=50,u.TYPED_ARRAY_SUPPORT=void 0!==t.TYPED_ARRAY_SUPPORT?t.TYPED_ARRAY_SUPPORT:function(){try{var t=new Uint8Array(1);return t.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===t.foo()&&"function"==typeof t.subarray&&0===t.subarray(1,1).byteLength}catch(t){return!1}}(),e.kMaxLength=s(),u.poolSize=8192,u._augment=function(t){return t.__proto__=u.prototype,t},u.from=function(t,e,n){return l(null,t,e,n)},u.TYPED_ARRAY_SUPPORT&&(u.prototype.__proto__=Uint8Array.prototype,u.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&u[Symbol.species]===u&&Object.defineProperty(u,Symbol.species,{value:null,configurable:!0})),u.alloc=function(t,e,n){return function(t,e,n,r){return c(e),e<=0?a(t,e):void 0!==n?"string"==typeof r?a(t,e).fill(n,r):a(t,e).fill(n):a(t,e)}(null,t,e,n)},u.allocUnsafe=function(t){return d(null,t)},u.allocUnsafeSlow=function(t){return d(null,t)},u.isBuffer=function(t){return!(null==t||!t._isBuffer)},u.compare=function(t,e){if(!u.isBuffer(t)||!u.isBuffer(e))throw new TypeError("Arguments must be Buffers");if(t===e)return 0;for(var n=t.length,r=e.length,o=0,i=Math.min(n,r);o<i;++o)if(t[o]!==e[o]){n=t[o],r=e[o];break}return n<r?-1:r<n?1:0},u.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(t,e){if(!i(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return u.alloc(0);var n;if(void 0===e)for(e=0,n=0;n<t.length;++n)e+=t[n].length;var r=u.allocUnsafe(e),o=0;for(n=0;n<t.length;++n){var s=t[n];if(!u.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(r,o),o+=s.length}return r},u.byteLength=p,u.prototype._isBuffer=!0,u.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var e=0;e<t;e+=2)g(this,e,e+1);return this},u.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var e=0;e<t;e+=4)g(this,e,e+3),g(this,e+1,e+2);return this},u.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var e=0;e<t;e+=8)g(this,e,e+7),g(this,e+1,e+6),g(this,e+2,e+5),g(this,e+3,e+4);return this},u.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?_(this,0,t):function(t,e,n){var r=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return T(this,e,n);case"utf8":case"utf-8":return _(this,e,n);case"ascii":return L(this,e,n);case"latin1":case"binary":return P(this,e,n);case"base64":return E(this,e,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return S(this,e,n);default:if(r)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),r=!0}}.apply(this,arguments)},u.prototype.equals=function(t){if(!u.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===u.compare(this,t)},u.prototype.inspect=function(){var t="",n=e.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,n).match(/.{2}/g).join(" "),this.length>n&&(t+=" ... ")),"<Buffer "+t+">"},u.prototype.compare=function(t,e,n,r,o){if(!u.isBuffer(t))throw new TypeError("Argument must be a Buffer");if(void 0===e&&(e=0),void 0===n&&(n=t?t.length:0),void 0===r&&(r=0),void 0===o&&(o=this.length),e<0||n>t.length||r<0||o>this.length)throw new RangeError("out of range index");if(r>=o&&e>=n)return 0;if(r>=o)return-1;if(e>=n)return 1;if(this===t)return 0;for(var i=(o>>>=0)-(r>>>=0),s=(n>>>=0)-(e>>>=0),a=Math.min(i,s),l=this.slice(r,o),c=t.slice(e,n),d=0;d<a;++d)if(l[d]!==c[d]){i=l[d],s=c[d];break}return i<s?-1:s<i?1:0},u.prototype.includes=function(t,e,n){return-1!==this.indexOf(t,e,n)},u.prototype.indexOf=function(t,e,n){return y(this,t,e,n,!0)},u.prototype.lastIndexOf=function(t,e,n){return y(this,t,e,n,!1)},u.prototype.write=function(t,e,n,r){if(void 0===e)r="utf8",n=this.length,e=0;else if(void 0===n&&"string"==typeof e)r=e,n=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e|=0,isFinite(n)?(n|=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var o=this.length-e;if((void 0===n||n>o)&&(n=o),t.length>0&&(n<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var i=!1;;)switch(r){case"hex":return v(this,t,e,n);case"utf8":case"utf-8":return b(this,t,e,n);case"ascii":return k(this,t,e,n);case"latin1":case"binary":return x(this,t,e,n);case"base64":return w(this,t,e,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return A(this,t,e,n);default:if(i)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),i=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var N=4096;function L(t,e,n){var r="";n=Math.min(t.length,n);for(var o=e;o<n;++o)r+=String.fromCharCode(127&t[o]);return r}function P(t,e,n){var r="";n=Math.min(t.length,n);for(var o=e;o<n;++o)r+=String.fromCharCode(t[o]);return r}function T(t,e,n){var r=t.length;(!e||e<0)&&(e=0),(!n||n<0||n>r)&&(n=r);for(var o="",i=e;i<n;++i)o+=X(t[i]);return o}function S(t,e,n){for(var r=t.slice(e,n),o="",i=0;i<r.length;i+=2)o+=String.fromCharCode(r[i]+256*r[i+1]);return o}function M(t,e,n){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>n)throw new RangeError("Trying to access beyond buffer length")}function R(t,e,n,r,o,i){if(!u.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>o||e<i)throw new RangeError('"value" argument is out of bounds');if(n+r>t.length)throw new RangeError("Index out of range")}function C(t,e,n,r){e<0&&(e=65535+e+1);for(var o=0,i=Math.min(t.length-n,2);o<i;++o)t[n+o]=(e&255<<8*(r?o:1-o))>>>8*(r?o:1-o)}function Y(t,e,n,r){e<0&&(e=4294967295+e+1);for(var o=0,i=Math.min(t.length-n,4);o<i;++o)t[n+o]=e>>>8*(r?o:3-o)&255}function I(t,e,n,r,o,i){if(n+r>t.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function B(t,e,n,r,i){return i||I(t,0,n,4),o.write(t,e,n,r,23,4),n+4}function O(t,e,n,r,i){return i||I(t,0,n,8),o.write(t,e,n,r,52,8),n+8}u.prototype.slice=function(t,e){var n,r=this.length;if((t=~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),(e=void 0===e?r:~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),e<t&&(e=t),u.TYPED_ARRAY_SUPPORT)(n=this.subarray(t,e)).__proto__=u.prototype;else{var o=e-t;n=new u(o,void 0);for(var i=0;i<o;++i)n[i]=this[i+t]}return n},u.prototype.readUIntLE=function(t,e,n){t|=0,e|=0,n||M(t,e,this.length);for(var r=this[t],o=1,i=0;++i<e&&(o*=256);)r+=this[t+i]*o;return r},u.prototype.readUIntBE=function(t,e,n){t|=0,e|=0,n||M(t,e,this.length);for(var r=this[t+--e],o=1;e>0&&(o*=256);)r+=this[t+--e]*o;return r},u.prototype.readUInt8=function(t,e){return e||M(t,1,this.length),this[t]},u.prototype.readUInt16LE=function(t,e){return e||M(t,2,this.length),this[t]|this[t+1]<<8},u.prototype.readUInt16BE=function(t,e){return e||M(t,2,this.length),this[t]<<8|this[t+1]},u.prototype.readUInt32LE=function(t,e){return e||M(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},u.prototype.readUInt32BE=function(t,e){return e||M(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},u.prototype.readIntLE=function(t,e,n){t|=0,e|=0,n||M(t,e,this.length);for(var r=this[t],o=1,i=0;++i<e&&(o*=256);)r+=this[t+i]*o;return r>=(o*=128)&&(r-=Math.pow(2,8*e)),r},u.prototype.readIntBE=function(t,e,n){t|=0,e|=0,n||M(t,e,this.length);for(var r=e,o=1,i=this[t+--r];r>0&&(o*=256);)i+=this[t+--r]*o;return i>=(o*=128)&&(i-=Math.pow(2,8*e)),i},u.prototype.readInt8=function(t,e){return e||M(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},u.prototype.readInt16LE=function(t,e){e||M(t,2,this.length);var n=this[t]|this[t+1]<<8;return 32768&n?4294901760|n:n},u.prototype.readInt16BE=function(t,e){e||M(t,2,this.length);var n=this[t+1]|this[t]<<8;return 32768&n?4294901760|n:n},u.prototype.readInt32LE=function(t,e){return e||M(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},u.prototype.readInt32BE=function(t,e){return e||M(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},u.prototype.readFloatLE=function(t,e){return e||M(t,4,this.length),o.read(this,t,!0,23,4)},u.prototype.readFloatBE=function(t,e){return e||M(t,4,this.length),o.read(this,t,!1,23,4)},u.prototype.readDoubleLE=function(t,e){return e||M(t,8,this.length),o.read(this,t,!0,52,8)},u.prototype.readDoubleBE=function(t,e){return e||M(t,8,this.length),o.read(this,t,!1,52,8)},u.prototype.writeUIntLE=function(t,e,n,r){(t=+t,e|=0,n|=0,r)||R(this,t,e,n,Math.pow(2,8*n)-1,0);var o=1,i=0;for(this[e]=255&t;++i<n&&(o*=256);)this[e+i]=t/o&255;return e+n},u.prototype.writeUIntBE=function(t,e,n,r){(t=+t,e|=0,n|=0,r)||R(this,t,e,n,Math.pow(2,8*n)-1,0);var o=n-1,i=1;for(this[e+o]=255&t;--o>=0&&(i*=256);)this[e+o]=t/i&255;return e+n},u.prototype.writeUInt8=function(t,e,n){return t=+t,e|=0,n||R(this,t,e,1,255,0),u.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[e]=255&t,e+1},u.prototype.writeUInt16LE=function(t,e,n){return t=+t,e|=0,n||R(this,t,e,2,65535,0),u.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):C(this,t,e,!0),e+2},u.prototype.writeUInt16BE=function(t,e,n){return t=+t,e|=0,n||R(this,t,e,2,65535,0),u.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):C(this,t,e,!1),e+2},u.prototype.writeUInt32LE=function(t,e,n){return t=+t,e|=0,n||R(this,t,e,4,4294967295,0),u.TYPED_ARRAY_SUPPORT?(this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t):Y(this,t,e,!0),e+4},u.prototype.writeUInt32BE=function(t,e,n){return t=+t,e|=0,n||R(this,t,e,4,4294967295,0),u.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):Y(this,t,e,!1),e+4},u.prototype.writeIntLE=function(t,e,n,r){if(t=+t,e|=0,!r){var o=Math.pow(2,8*n-1);R(this,t,e,n,o-1,-o)}var i=0,s=1,a=0;for(this[e]=255&t;++i<n&&(s*=256);)t<0&&0===a&&0!==this[e+i-1]&&(a=1),this[e+i]=(t/s>>0)-a&255;return e+n},u.prototype.writeIntBE=function(t,e,n,r){if(t=+t,e|=0,!r){var o=Math.pow(2,8*n-1);R(this,t,e,n,o-1,-o)}var i=n-1,s=1,a=0;for(this[e+i]=255&t;--i>=0&&(s*=256);)t<0&&0===a&&0!==this[e+i+1]&&(a=1),this[e+i]=(t/s>>0)-a&255;return e+n},u.prototype.writeInt8=function(t,e,n){return t=+t,e|=0,n||R(this,t,e,1,127,-128),u.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[e]=255&t,e+1},u.prototype.writeInt16LE=function(t,e,n){return t=+t,e|=0,n||R(this,t,e,2,32767,-32768),u.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):C(this,t,e,!0),e+2},u.prototype.writeInt16BE=function(t,e,n){return t=+t,e|=0,n||R(this,t,e,2,32767,-32768),u.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):C(this,t,e,!1),e+2},u.prototype.writeInt32LE=function(t,e,n){return t=+t,e|=0,n||R(this,t,e,4,2147483647,-2147483648),u.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24):Y(this,t,e,!0),e+4},u.prototype.writeInt32BE=function(t,e,n){return t=+t,e|=0,n||R(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),u.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):Y(this,t,e,!1),e+4},u.prototype.writeFloatLE=function(t,e,n){return B(this,t,e,!0,n)},u.prototype.writeFloatBE=function(t,e,n){return B(this,t,e,!1,n)},u.prototype.writeDoubleLE=function(t,e,n){return O(this,t,e,!0,n)},u.prototype.writeDoubleBE=function(t,e,n){return O(this,t,e,!1,n)},u.prototype.copy=function(t,e,n,r){if(n||(n=0),r||0===r||(r=this.length),e>=t.length&&(e=t.length),e||(e=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),t.length-e<r-n&&(r=t.length-e+n);var o,i=r-n;if(this===t&&n<e&&e<r)for(o=i-1;o>=0;--o)t[o+e]=this[o+n];else if(i<1e3||!u.TYPED_ARRAY_SUPPORT)for(o=0;o<i;++o)t[o+e]=this[o+n];else Uint8Array.prototype.set.call(t,this.subarray(n,n+i),e);return i},u.prototype.fill=function(t,e,n,r){if("string"==typeof t){if("string"==typeof e?(r=e,e=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),1===t.length){var o=t.charCodeAt(0);o<256&&(t=o)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!u.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof t&&(t&=255);if(e<0||this.length<e||this.length<n)throw new RangeError("Out of range index");if(n<=e)return this;var i;if(e>>>=0,n=void 0===n?this.length:n>>>0,t||(t=0),"number"==typeof t)for(i=e;i<n;++i)this[i]=t;else{var s=u.isBuffer(t)?t:D(new u(t,r).toString()),a=s.length;for(i=0;i<n-e;++i)this[i+e]=s[i%a]}return this};var U=/[^+\/0-9A-Za-z-_]/g;function X(t){return t<16?"0"+t.toString(16):t.toString(16)}function D(t,e){var n;e=e||1/0;for(var r=t.length,o=null,i=[],s=0;s<r;++s){if((n=t.charCodeAt(s))>55295&&n<57344){if(!o){if(n>56319){(e-=3)>-1&&i.push(239,191,189);continue}if(s+1===r){(e-=3)>-1&&i.push(239,191,189);continue}o=n;continue}if(n<56320){(e-=3)>-1&&i.push(239,191,189),o=n;continue}n=65536+(o-55296<<10|n-56320)}else o&&(e-=3)>-1&&i.push(239,191,189);if(o=null,n<128){if((e-=1)<0)break;i.push(n)}else if(n<2048){if((e-=2)<0)break;i.push(n>>6|192,63&n|128)}else if(n<65536){if((e-=3)<0)break;i.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;i.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return i}function q(t){return r.toByteArray(function(t){if((t=function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}(t).replace(U,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function z(t,e,n,r){for(var o=0;o<r&&!(o+n>=e.length||o>=t.length);++o)e[o+n]=t[o];return o}}).call(this,n(6))},function(t,e,n){"use strict";e.byteLength=function(t){var e=l(t),n=e[0],r=e[1];return 3*(n+r)/4-r},e.toByteArray=function(t){for(var e,n=l(t),r=n[0],s=n[1],a=new i(function(t,e,n){return 3*(e+n)/4-n}(0,r,s)),u=0,c=s>0?r-4:r,d=0;d<c;d+=4)e=o[t.charCodeAt(d)]<<18|o[t.charCodeAt(d+1)]<<12|o[t.charCodeAt(d+2)]<<6|o[t.charCodeAt(d+3)],a[u++]=e>>16&255,a[u++]=e>>8&255,a[u++]=255&e;2===s&&(e=o[t.charCodeAt(d)]<<2|o[t.charCodeAt(d+1)]>>4,a[u++]=255&e);1===s&&(e=o[t.charCodeAt(d)]<<10|o[t.charCodeAt(d+1)]<<4|o[t.charCodeAt(d+2)]>>2,a[u++]=e>>8&255,a[u++]=255&e);return a},e.fromByteArray=function(t){for(var e,n=t.length,o=n%3,i=[],s=0,a=n-o;s<a;s+=16383)i.push(c(t,s,s+16383>a?a:s+16383));1===o?(e=t[n-1],i.push(r[e>>2]+r[e<<4&63]+"==")):2===o&&(e=(t[n-2]<<8)+t[n-1],i.push(r[e>>10]+r[e>>4&63]+r[e<<2&63]+"="));return i.join("")};for(var r=[],o=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,u=s.length;a<u;++a)r[a]=s[a],o[s.charCodeAt(a)]=a;function l(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");return-1===n&&(n=e),[n,n===e?0:4-n%4]}function c(t,e,n){for(var o,i,s=[],a=e;a<n;a+=3)o=(t[a]<<16&16711680)+(t[a+1]<<8&65280)+(255&t[a+2]),s.push(r[(i=o)>>18&63]+r[i>>12&63]+r[i>>6&63]+r[63&i]);return s.join("")}o["-".charCodeAt(0)]=62,o["_".charCodeAt(0)]=63},function(t,e){e.read=function(t,e,n,r,o){var i,s,a=8*o-r-1,u=(1<<a)-1,l=u>>1,c=-7,d=n?o-1:0,h=n?-1:1,f=t[e+d];for(d+=h,i=f&(1<<-c)-1,f>>=-c,c+=a;c>0;i=256*i+t[e+d],d+=h,c-=8);for(s=i&(1<<-c)-1,i>>=-c,c+=r;c>0;s=256*s+t[e+d],d+=h,c-=8);if(0===i)i=1-l;else{if(i===u)return s?NaN:1/0*(f?-1:1);s+=Math.pow(2,r),i-=l}return(f?-1:1)*s*Math.pow(2,i-r)},e.write=function(t,e,n,r,o,i){var s,a,u,l=8*i-o-1,c=(1<<l)-1,d=c>>1,h=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,f=r?0:i-1,p=r?1:-1,g=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=c):(s=Math.floor(Math.log(e)/Math.LN2),e*(u=Math.pow(2,-s))<1&&(s--,u*=2),(e+=s+d>=1?h/u:h*Math.pow(2,1-d))*u>=2&&(s++,u/=2),s+d>=c?(a=0,s=c):s+d>=1?(a=(e*u-1)*Math.pow(2,o),s+=d):(a=e*Math.pow(2,d-1)*Math.pow(2,o),s=0));o>=8;t[n+f]=255&a,f+=p,a/=256,o-=8);for(s=s<<o|a,l+=o;l>0;t[n+f]=255&s,f+=p,s/=256,l-=8);t[n+f-p]|=128*g}},function(t,e){var n={}.toString;t.exports=Array.isArray||function(t){return"[object Array]"==n.call(t)}},function(t,e,n){for(var r=n(14),o=[],i={},s=0;s<256;s++)o[s]=(s+256).toString(16).substr(1),i[o[s]]=s;function a(t,e){var n=e||0,r=o;return r[t[n++]]+r[t[n++]]+r[t[n++]]+r[t[n++]]+"-"+r[t[n++]]+r[t[n++]]+"-"+r[t[n++]]+r[t[n++]]+"-"+r[t[n++]]+r[t[n++]]+"-"+r[t[n++]]+r[t[n++]]+r[t[n++]]+r[t[n++]]+r[t[n++]]+r[t[n++]]}var u=r(),l=[1|u[0],u[1],u[2],u[3],u[4],u[5]],c=16383&(u[6]<<8|u[7]),d=0,h=0;function f(t,e,n){var o=e&&n||0;"string"==typeof t&&(e="binary"==t?new Array(16):null,t=null);var i=(t=t||{}).random||(t.rng||r)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,e)for(var s=0;s<16;s++)e[o+s]=i[s];return e||a(i)}var p=f;p.v1=function(t,e,n){var r=e&&n||0,o=e||[],i=void 0!==(t=t||{}).clockseq?t.clockseq:c,s=void 0!==t.msecs?t.msecs:(new Date).getTime(),u=void 0!==t.nsecs?t.nsecs:h+1,f=s-d+(u-h)/1e4;if(f<0&&void 0===t.clockseq&&(i=i+1&16383),(f<0||s>d)&&void 0===t.nsecs&&(u=0),u>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");d=s,h=u,c=i;var p=(1e4*(268435455&(s+=122192928e5))+u)%4294967296;o[r++]=p>>>24&255,o[r++]=p>>>16&255,o[r++]=p>>>8&255,o[r++]=255&p;var g=s/4294967296*1e4&268435455;o[r++]=g>>>8&255,o[r++]=255&g,o[r++]=g>>>24&15|16,o[r++]=g>>>16&255,o[r++]=i>>>8|128,o[r++]=255&i;for(var y=t.node||l,m=0;m<6;m++)o[r+m]=y[m];return e||a(o)},p.v4=f,p.parse=function(t,e,n){var r=e&&n||0,o=0;for(e=e||[],t.toLowerCase().replace(/[0-9a-f]{2}/g,function(t){o<16&&(e[r+o++]=i[t])});o<16;)e[r+o++]=0;return e},p.unparse=a,t.exports=p},function(t,e,n){(function(e){var n,r=e.crypto||e.msCrypto;if(r&&r.getRandomValues){var o=new Uint8Array(16);n=function(){return r.getRandomValues(o),o}}if(!n){var i=new Array(16);n=function(){for(var t,e=0;e<16;e++)0==(3&e)&&(t=4294967296*Math.random()),i[e]=t>>>((3&e)<<3)&255;return i}}t.exports=n}).call(this,n(6))},function(t,e,n){},function(t,e,n){"use strict";n.r(e);var o=n(1),i=n.n(o),s=n(0),a=n.n(s),u=n(2),l=n.n(u),c=(n(15),n(7)),d=n.n(c);function h(t,e){var n,r,o=!1,i=l.a.nice(),s=null,u="right",c=null,f=null;return"function"==typeof e?n=e:(n=(e=e||{}).onOpen,r=e.onClose),"rootElement"in e&&(s=e.rootElement),"pos"in e&&(c=e.pos),"orientation"in e&&(u=e.orientation),"parentStart"in e&&(f=e.parentStart),a.a.selectAll(".d3-context-menu-"+i).data([1]).enter().append("div").classed("d3-context-menu",!0).classed("d3-context-menu-"+i,!0),a.a.select("body").on("click.d3-context-menu-"+i,function(){o?o=!1:(console.log("body click close"),a.a.select(".d3-context-menu-"+i).style("display","none"),u="right",r&&r())}),function(e,l){var p=arguments.length>2&&void 0!==arguments[2]&&arguments[2],g=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){},y=this,m=null,v=this;m=null==s?a.a.mouse(this):a.a.mouse(s),g;var b=null;o=p,a.a.selectAll(".d3-context-menu-"+i).html("");var k=a.a.selectAll(".d3-context-menu-"+i).on("contextmenu",function(t){console.log("context-menu close"),a.a.select(".d3-context-menu-"+i).style("display","none"),u="right",a.a.event.preventDefault(),a.a.event.stopPropagation()}).append("ul");if(k.selectAll("li").data("function"==typeof t?t(e):t).enter().append("li").attr("class",function(t){console.log("d:",t);var e="";return t.divider&&(e+=" is-divider"),t.disabled&&(e+=" is-disabled"),t.action||(e+=" is-header"),"children"in t&&(e+=" d3-context-menu-recursive"),e}).html(function(t){return t.divider?"<hr>":(t.title||console.error("No title attribute set. Check the spelling of your options."),"string"==typeof t.title?t.title:t.title(e))}).on("click",function(t,n){t.disabled||t.action&&(t.action(y,e,l,m),console.log("click close"),a.a.selectAll(".d3-context-menu").style("display","none"),u="right",r&&r())}).on("mouseenter",function(t,n){if(a.a.select(this).classed("d3-context-menu-selected",!0),null!=b){if(a.a.select(".d3-context-menu-"+i).selectAll("li").classed("d3-context-menu-selected",!1),void 0===t.children)return console.log("no children close"),a.a.select(".d3-context-menu-"+b).style("display","none"),void(b=null);if(t.childUid==b)return;console.log("open different child menu close"),a.a.select(".d3-context-menu-"+b).style("display","none"),b=null}if(void 0!==t.children){var r=this.getBoundingClientRect(),o=null;o=h(t.children,"left"==u?{rootElement:v,pos:[r.left+window.pageXOffset,r.top-2+window.pageYOffset],orientation:"left"}:{pos:[r.left+r.width+window.pageXOffset,r.top-2+window.pageYOffset],rootElement:v,parentStart:[r.left+window.pageXOffset,r.top-2+window.pageYOffset]}),t.childUid=o.apply(this,[e,n,!0,function(){}]),b=t.childUid}a.a.select(this).classed("d3-context-menu-selected",!0)}).on("mouseleave",function(t,e){null==b&&a.a.select(this).classed("d3-context-menu-selected",!1)}),k.selectAll(".d3-context-menu-recursive").append("img").attr("src",d.a).attr("width","14px").attr("height","14px").style("position","absolute").style("right","5px"),n&&!1===n(e,l))return i;var x=a.a.select(".d3-context-menu-"+i).style("display","block");null==c?a.a.select(".d3-context-menu-"+i).style("left",a.a.event.pageX-2+"px").style("top",a.a.event.pageY-2+"px"):a.a.select(".d3-context-menu-"+i).style("left",c[0]+"px").style("top",c[1]+"px");var w=x.node().getBoundingClientRect();return(w.left+w.width>window.innerWidth||"left"==u)&&(u="left",null==c?a.a.select(".d3-context-menu-"+i).style("left",a.a.event.pageX-2-w.width+"px").style("top",a.a.event.pageY-2+"px"):null!=f?a.a.select(".d3-context-menu-"+i).style("left",f[0]-w.width+"px").style("top",f[1]+"px"):a.a.select(".d3-context-menu-"+i).style("left",c[0]-w.width+"px").style("top",c[1]+"px")),o?i:(a.a.event.preventDefault(),a.a.event.stopPropagation(),i)}}var f=function(t,e){return t-e};function p(){var t=this;t.bracketLeft="([{<ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),t.bracketRight=")]}>abcdefghijklmnopqrstuvwxyz".split(""),t.inverseBrackets=function(t){for(var e={},n=0;n<t.length;n++)e[t[n]]=n;return e},t.maximumMatching=function(t){for(var e=t[0],n=new Array(e+1),r=0;r<=e;r++){n[r]=new Array(e+1);for(var o=r;o<=e;o++)n[r][o]=0}var i=0;for(r=e-0-1;r>0;r--)for(o=r+0+1;o<=e;o++){i=n[r][o-1];for(var s=o-0-1;s>=r;s--)t[s]===o&&(i=Math.max(i,(s>r?n[r][s-1]:0)+1+(o-s-1>0?n[s+1][o-1]:0)));n[r][o]=i}return i=n[1][e],n},t.backtrackMaximumMatching=function(e,n){var r=Array.apply(null,Array(e.length)).map(function(){return 0});return t.mmBt(e,r,n,1,e.length-1),r},t.mmBt=function(e,n,r,o,i){var s=e[o][i];if(!(i-o-1<0))if(e[o][i-1]!=s){for(var a=i-0-1;a>=o;a--){if(r[i]===a)if((a>o?e[o][a-1]:0)+(i-a-1>0?e[a+1][i-1]:0)+1==s)return n[a]=i,n[i]=a,o<a&&t.mmBt(e,n,r,o,a-1),void t.mmBt(e,n,r,a+1,i-1)}console.log("FAILED!!!"+o+","+i+": backtracking failed!")}else t.mmBt(e,n,r,o,i-1)},t.dotbracketToPairtable=function(e){var n=Array.apply(null,new Array(e.length+1)).map(Number.prototype.valueOf,0);n[0]=e.length;for(var r={},o=0;o<t.bracketLeft.length;o++)r[o]=[];var i=t.inverseBrackets(t.bracketLeft),s=t.inverseBrackets(t.bracketRight);for(o=0;o<e.length;o++){var a=e[o],u=o+1;if("."==a||"o"==a)n[u]=0;else if(a in i)r[i[a]].push(u);else{if(!(a in s))throw"Unknown symbol in dotbracket string";var l=r[s[a]].pop();n[u]=l,n[l]=u}}for(var c in r)if(r[c].length>0)throw"Unmatched base at position "+r[c][0];return n},t.insertIntoStack=function(t,e,n){for(var r=0;t[r].length>0&&t[r][t[r].length-1]<n;)r+=1;return t[r].push(n),r},t.deleteFromStack=function(t,e){for(var n=0;0===t[n].length||t[n][t[n].length-1]!=e;)n+=1;return t[n].pop(),n},t.pairtableToDotbracket=function(e){for(var n={},r=0;r<e[0];r++)n[r]=[];var o={},i="";for(r=1;r<e[0]+1;r++){if(0!==e[r]&&e[r]in o)throw"Invalid pairtable contains duplicate entries";o[e[r]]=!0,0===e[r]?i+=".":e[r]>r?i+=t.bracketLeft[t.insertIntoStack(n,r,e[r])]:i+=t.bracketRight[t.deleteFromStack(n,r)]}return i},t.findUnmatched=function(e,n,r){for(var o=[],i=[],s=n,a=r,u=n;u<=r;u++)0!==e[u]&&(e[u]<n||e[u]>r)&&i.push([u,e[u]]);for(u=s;u<=a;u++){for(;0===e[u]&&u<=a;)u++;for(r=e[u];e[u]===r;)u++,r--;o=o.concat(t.findUnmatched(e,u,r))}return i.length>0&&o.push(i),o},t.removePseudoknotsFromPairtable=function(e){for(var n=t.maximumMatching(e),r=t.backtrackMaximumMatching(n,e),o=[],i=1;i<e.length;i++)e[i]<i||r[i]!=e[i]&&(o.push([i,e[i]]),e[e[i]]=0,e[i]=0);return o},t.ptToElements=function(e,n,r,o,i){var s=[],a=[r-1],u=[o+1];if(arguments.length<5&&(i=[]),r>o)return[];for(;0===e[r];r++)a.push(r);for(;0===e[o];o--)u.push(o);if(r>o){if(a.push(r),0===n)return[["e",n,a.sort(f)]];for(var l=!1,c=[],d=[],h=0;h<a.length;h++)l?d.push(a[h]):c.push(a[h]),i.indexOf(a[h])>=0&&(l=!0);return[["h",n,a.sort(f)]]}if(e[r]!=o){var p=a;h=r;for(p.push(h);h<=o;){for(s=s.concat(t.ptToElements(e,n,h,e[h],i)),p.push(e[h]),h=e[h]+1;0===e[h]&&h<=o;h++)p.push(h);p.push(h)}return p.pop(),(p=p.concat(u)).length>0&&(0===n?s.push(["e",n,p.sort(f)]):s.push(["m",n,p.sort(f)])),s}e[r]===o&&(a.push(r),u.push(o),a.concat(u).length>4&&(0===n?s.push(["e",n,a.concat(u).sort(f)]):s.push(["i",n,a.concat(u).sort(f)])));for(var g=[];e[r]===o&&r<o;)g.push(r),g.push(o),r+=1,o-=1,n+=1;return a=[r-1],u=[o+1],s.push(["s",n,g.sort(f)]),s.concat(t.ptToElements(e,n,r,o,i))}}var g=new p;function y(t){var e=this;return e.colorsText=t,e.parseRange=function(t){for(var e=t.split(","),n=[],r=0;r<e.length;r++){var o=e[r].split("-");if(1==o.length)n.push(parseInt(o[0]));else if(2==o.length)for(var i=parseInt(o[0]),s=parseInt(o[1]),a=i;a<=s;a++)n.push(a);else console.log("Malformed range (too many dashes):",t)}return n},e.parseColorText=function(t){for(var n=t.split("\n"),r="",o=1,i={colorValues:{"":{}},range:["white","steelblue"]},s=[],a=0;a<n.length;a++)if(">"!=n[a][0])for(var u=n[a].trim().split(/[\s]+/),l=0;l<u.length;l++)if(isNaN(u[l])){if(0===u[l].search("range")){var c=u[l].split("=")[1].split(":");i.range=[c[0],c[1]];continue}if(0==u[l].search("domain")){var d=u[l].split("=")[1].split(":");i.domain=[d[0],d[1]];continue}for(var h=u[l].split(":"),f=e.parseRange(h[0]),p=h[1],g=0;g<f.length;g++)isNaN(p)?i.colorValues[r][f[g]]=p:(i.colorValues[r][f[g]]=+p,s.push(Number(p)))}else i.colorValues[r][o]=Number(u[l]),o+=1,s.push(Number(u[l]));else r=n[a].trim().slice(1),o=1,i.colorValues[r]={};return"domain"in i||(i.domain=[Math.min.apply(null,s),Math.max.apply(null,s)]),e.colorsJson=i,e},e.normalizeColors=function(){var t;for(var n in e.colorsJson){var r=Number.MAX_VALUE,o=Number.MIN_VALUE;for(var i in e.colorsJson.colorValues[n])"number"==typeof(t=e.colorsJson.colorValues[n][i])&&(t<r&&(r=t),t>o&&(o=t));for(i in e.colorsJson.colorValues[n])"number"==typeof(t=e.colorsJson.colorValues[n][i])&&(e.colorsJson.colorValues[n][i]=(t-r)/(o-r))}return e},e.parseColorText(e.colorsText),e}var m=function(t,e){return t-e};function v(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=this;o.type="rna",o.circularizeExternal=!1,o.seq=t,o.dotbracket=e,o.structName=n,o.circular=!1,"*"==o.dotbracket.slice(-1)&&(o.dotbracket=o.dotbracket.slice(0,-1),o.circular=!0),o.uid=l.a.nice(),o.elements=[],o.pseudoknotPairs=[],o.nucsToNodes={},o.addUids=function(t){for(var e=o.nodes.filter(function(t){return"nucleotide"==t.nodeType}),n=0;n<t.length&&n<e.length;n++)e[n].uid=t[n];return o},o.computePairtable=function(){o.pairtable=g.dotbracketToPairtable(o.dotbracket)},o.removeBreaks=function(t){for(var e=[],n=-1;(n=t.indexOf("&"))>=0;)e.push(n),t=t.substring(0,n)+t.substring(n+1,t.length);return{targetString:t,breaks:e}};var i=o.removeBreaks(o.dotbracket);o.dotbracket=i.targetString,o.dotBracketBreaks=i.breaks,i=o.removeBreaks(o.seq),o.seq=i.targetString,o.seqBreaks=i.breaks,o.rnaLength=o.dotbracket.length,function(t,e){if(t===e)return!0;if(null===t||null===e)return!1;if(t.length!=e.length)return!1;for(var n=0;n<t.length;++n)if(t[n]!==e[n])return!1;return!0}(o.dotBracketBreaks,o.seqBreaks)||(console.log("WARNING: Sequence and structure breaks not equal"),console.log("WARNING: Using the breaks in the structure")),o.computePairtable(),o.addPositions=function(t,e){for(var n=o.nodes.filter(function(e){return e.nodeType==t}),r=0;r<n.length;r++)n[r].x=e[r][0],n[r].y=e[r][1];return o},o.breakNodesToFakeNodes=function(){for(var t=o.nodes.filter(function(t){return"nucleotide"==t.nodeType}),e=0;e<t.length;e++)o.dotBracketBreaks.indexOf(e)>=0&&(t[e].nodeType="middle",t[e+1].nodeType="middle");for(var n=function(t){i=!1;for(var e=0;e<o.elements[t][2].length;e++)o.dotBracketBreaks.indexOf(o.elements[t][2][e])>=0&&(i=!0);i?o.elements[t][2].map(function(t){0!=t&&(o.nodes[t-1].elemType="e")}):o.elements[t][2].map(function(e){0!=e&&(o.nodes[e-1].elemType=o.elements[t][0])})},r=0;r<o.elements.length;r++){var i;n(r)}return o},o.getPositions=function(t){for(var e=[],n=o.nodes.filter(function(e){return e.nodeType==t}),r=0;r<n.length;r++)e.push([n[r].x,n[r].y]);return e},o.getUids=function(){for(var t=[],e=0;e<o.dotbracket.length;e++)t.push(o.nodes[e].uid);return t},o.reinforceStems=function(){for(var t=o.pairtable,e=o.elements.filter(function(t){return"s"==t[0]&&t[2].length>=4}),n=0;n<e.length;n++)for(var r=e[n][2],i=r.slice(0,r.length/2),s=0;s<i.length-1;s++)o.addFakeNode([i[s],i[s+1],t[i[s+1]],t[i[s]]]);return o},o.reinforceLoops=function(){for(var t=function(t){return 0!==t&&t<=o.dotbracket.length},e=0;e<o.elements.length;e++)if("s"!=o.elements[e][0]&&(o.circularizeExternal||"e"!=o.elements[e][0])){var n=o.elements[e][2].filter(t);if("e"==o.elements[e][0]){var r={name:"",num:-3,radius:0,rna:o,nodeType:"middle",elemType:"f",nucs:[],x:o.nodes[o.rnaLength-1].x,y:o.nodes[o.rnaLength-1].y,px:o.nodes[o.rnaLength-1].px,py:o.nodes[o.rnaLength-1].py,uid:l.a.nice()},i={name:"",num:-2,radius:0,rna:o,nodeType:"middle",elemType:"f",nucs:[],x:o.nodes[0].x,y:o.nodes[0].y,px:o.nodes[0].px,py:o.nodes[0].py,uid:l.a.nice()};n.push(o.nodes.length+1),n.push(o.nodes.length+2),o.nodes.push(r),o.nodes.push(i)}o.addFakeNode(n)}return o},o.updateLinkUids=function(){for(var t=0;t<o.links.length;t++)o.links[t].uid=o.links[t].source.uid+o.links[t].target.uid;return o},o.addFakeNode=function(t){for(var e=6.283/(2*t.length),n=18/(2*Math.tan(e)),r="",i=0;i<t.length;i++)r+=o.nodes[t[i]-1].uid;var s={name:"",num:-1,radius:n,rna:o,nodeType:"middle",elemType:"f",nucs:t,uid:r};o.nodes.push(s);var a=0,u=0,c=0;e=3.14159*(t.length-2)/(2*t.length),n=.5/Math.cos(e);for(var d=0;d<t.length;d++)if(!(0===t[d]||t[d]>o.dotbracket.length)){o.links.push({source:o.nodes[t[d]-1],target:o.nodes[o.nodes.length-1],linkType:"fake",value:n,uid:l.a.nice()}),t.length>4&&o.links.push({source:o.nodes[t[d]-1],target:o.nodes[t[(d+Math.floor(t.length/2))%t.length]-1],linkType:"fake",value:2*n,uid:l.a.nice()});var h=3.14159*(t.length-2)/t.length,f=2*Math.cos(1.570795-h/2);o.links.push({source:o.nodes[t[d]-1],target:o.nodes[t[(d+2)%t.length]-1],linkType:"fake",value:f});var p=o.nodes[t[d]-1];"x"in p&&(a+=p.x,u+=p.y,c+=1)}return c>0&&(s.x=a/c,s.y=u/c,s.px=s.x,s.py=s.y),o},o.connectFakeNodes=function(){for(var t={},e=o.nodes.filter(function(t){return"middle"==t.nodeType}),n={},r=1;r<=o.nodes.length;r++)t[r]=[];for(r=0;r<e.length;r++)for(var i=e[r],s=0;s<i.nucs.length;s++){for(var a=i.nucs[s],u=0;u<t[a].length;u++)if(!(JSON.stringify([t[a][u].uid,i.uid].sort())in n)){var l=t[a][u].radius+i.radius;o.links.push({source:t[a][u],target:i,value:l/18,linkType:"fake_fake"}),n[JSON.stringify([t[a][u].uid,i.uid].sort())]=!0}t[a].push(i)}return o},o.addExtraLinks=function(t){if(void 0===t)return o;for(var e=0;e<t.length;e++){var n={source:o.getNodeFromNucleotides(t[e].from),target:o.getNodeFromNucleotides(t[e].to),linkType:"extra",extraLinkType:t[e].linkType,uid:l.a.nice()};o.links.push(n)}return o},o.elementsToJson=function(){var t=o.pairtable;o.elements;o.nodes=[],o.links=[];var e={};o.elements.sort();for(var n=0;n<o.elements.length;n++)for(var i=o.elements[n][2],s=0;s<i.length;s++)e[i[s]]=o.elements[n][0];for(var a=1;a<=t[0];a++){var u=o.seq[a-1];(o.dotBracketBreaks.indexOf(a-1)>=0||o.dotBracketBreaks.indexOf(a-2)>=0)&&(u=""),o.nodes.push({name:u,num:r+a-1,radius:5,rna:o,nodeType:"nucleotide",structName:o.structName,elemType:e[a],uid:l.a.nice(),linked:!1})}for(var c=0;c<o.nodes.length;c++)o.nodes[c].prevNode=0===c?null:o.nodes[c-1],c==o.nodes.length-1?o.nodes[c].nextNode=null:o.nodes[c].nextNode=o.nodes[c+1];for(var d=1;d<=t[0];d++)0!==t[d]&&o.links.push({source:o.nodes[d-1],target:o.nodes[t[d]-1],linkType:"basepair",value:1,uid:l.a.nice()}),d>1&&-1===o.dotBracketBreaks.indexOf(d-1)&&-1==o.dotBracketBreaks.indexOf(d-2)&&-1==o.dotBracketBreaks.indexOf(d-3)&&(o.links.push({source:o.nodes[d-2],target:o.nodes[d-1],linkType:"backbone",value:1,uid:l.a.nice()}),o.nodes[d-1].linked=!0);for(var h=0;h<o.pseudoknotPairs.length;h++)o.links.push({source:o.nodes[o.pseudoknotPairs[h][0]-1],target:o.nodes[o.pseudoknotPairs[h][1]-1],linkType:"pseudoknot",value:1,uid:l.a.nice()});return o.circular&&o.links.push({source:o.nodes[0],target:o.nodes[o.rnaLength-1],linkType:"backbone",value:1,uid:l.a.nice()}),o},o.ptToElements=function(t,e,n,r){var i=[],s=[n-1],a=[r+1];if(n>r)return[];for(;0===t[n];n++)s.push(n);for(;0===t[r];r--)a.push(r);if(n>r){if(s.push(n),0===e)return[["e",e,s.sort(m)]];for(var u=!1,l=[],c=[],d=0;d<s.length;d++)u?c.push(s[d]):l.push(s[d]),o.dotBracketBreaks.indexOf(s[d])>=0&&(u=!0);return[["h",e,s.sort(m)]]}if(t[n]!=r){var h=s;d=n;for(h.push(d);d<=r;){for(i=i.concat(o.ptToElements(t,e,d,t[d])),h.push(t[d]),d=t[d]+1;0===t[d]&&d<=r;d++)h.push(d);h.push(d)}return h.pop(),(h=h.concat(a)).length>0&&(0===e?i.push(["e",e,h.sort(m)]):i.push(["m",e,h.sort(m)])),i}t[n]===r&&(s.push(n),a.push(r),s.concat(a).length>4&&(0===e?i.push(["e",e,s.concat(a).sort(m)]):i.push(["i",e,s.concat(a).sort(m)])));for(var f=[];t[n]===r&&n<r;)f.push(n),f.push(r),n+=1,r-=1,e+=1;return s=[n-1],a=[r+1],i.push(["s",e,f.sort(m)]),i.concat(o.ptToElements(t,e,n,r))},o.addLabels=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;if(0===e)return o;for(var n=1;n<=o.rnaLength;n++)if(n%e==0){var r,i,s=o.nodes[n-1],a=void 0,u=void 0,c=void 0,d=void 0;1==o.rnaLength?(d=[s.x-15,s.y],c=[s.x-15,s.y]):(a=1==n?o.nodes[o.rnaLength-1]:o.nodes[n-2],u=n==o.rnaLength?o.nodes[0]:o.nodes[n],0!==o.pairtable[u.num-t+1]&&0!==o.pairtable[a.num-t+1]&&0!==o.pairtable[s.num-t+1]&&(a=u=o.nodes[o.pairtable[s.num-t+1]-1]),0===o.pairtable[s.num-t+1]||0!==o.pairtable[u.num-t+1]&&0!==o.pairtable[a.num-t+1]?(d=[u.x-s.x,u.y-s.y],c=[a.x-s.x,a.y-s.y]):(d=[s.x-u.x,s.y-u.y],c=[s.x-a.x,s.y-a.y]));var h=[d[0]+c[0],d[1]+c[1]],f=Math.sqrt(h[0]*h[0]+h[1]*h[1]),p=[h[0]/f,h[1]/f],g=[-15*p[0],-15*p[1]];r=o.nodes[n-1].x+g[0],i=o.nodes[n-1].y+g[1];var y={name:n+t-1,num:-1,radius:6,rna:o,nodeType:"label",structName:o.structName,elemType:"l",x:r,y:i,px:r,py:i,uid:l.a.nice()},m={source:o.nodes[n-1],target:y,value:1,linkType:"label_link",uid:l.a.nice()};o.nodes.push(y),o.links.push(m)}return o},o.recalculateElements=function(){if(o.removePseudoknots(),o.elements=o.ptToElements(o.pairtable,0,1,o.dotbracket.length),o.circular){var t=o.elements.filter(function(t){if("e"==t[0])return!0});if(t.length>0){eloop=t[0],nucs=eloop[2].sort(m),prev=nucs[0],hloop=!0,numGreater=0;for(var e=1;e<nucs.length;e++)nucs[e]-prev>1&&(numGreater+=1),prev=nucs[e];1==numGreater?eloop[0]="h":2==numGreater?eloop[0]="i":eloop[0]="m"}}return o},o.reassignLinkUids=function(){for(var t=0;t<o.links.length;t++)o.links[t].uid=o.links[t].source.uid+o.links[t].target.uid;return o},o.removePseudoknots=function(){return o.pairtable.length>1&&(o.pseudoknotPairs=o.pseudoknotPairs.concat(g.removePseudoknotsFromPairtable(o.pairtable))),o},o.addPseudoknots=function(){for(var t=o.pairtable,e=o.pseudoknotPairs,n=0;n<e.length;n++)t[e[n][0]]=e[n][1],t[e[n][1]]=e[n][0];return o.pseudoknotPairs=[],o},o.addName=function(t){return void 0===t?(o.name="",o):(o.name=t,o)},o.rnaLength>0&&o.recalculateElements(),o.getNodeFromNucleotides=function(t){if("[object Array]"===Object.prototype.toString.call(t)){for(var e=0;e<o.nodes.length;e++)if("nucs"in o.nodes[e]&&o.nodes[e].nucs.equals(t))return o.nodes[e]}else for(var n=0;n<o.nodes.length;n++)if(o.nodes[n].num==t)return o.nodes[n];return console.log("ERROR: No node found for nucs:",t),null}}function b(t){var e,n,r,o=[],i=[];n=t[0];var s=Array.apply(null,new Array(n+5)).map(Number.prototype.valueOf,0),a=Array.apply(null,new Array(16+Math.floor(n/5))).map(Number.prototype.valueOf,0),u=Array.apply(null,new Array(16+Math.floor(n/5))).map(Number.prototype.valueOf,0),l=0,c=0,d=Math.PI/2;!function t(e,n,r){var o,i,h,f,p,g,y,m,v,b,k,x,w=2,A=0,E=0,_=Array.apply(null,new Array(3+2*Math.floor((n-e)/5))).map(Number.prototype.valueOf,0);for(o=e-1,n++;e!=n;)if((i=r[e])&&0!=e){w+=2,h=e,f=i,_[++A]=h,_[++A]=f,e=i+1,p=h,g=f,m=0;do{h++,f--,m++}while(r[h]==f&&r[h]>h);if(y=m-2,m>=2&&(s[p+1+y]+=d,s[g-1-y]+=d,s[p]+=d,s[g]+=d,m>2))for(;y>=1;y--)s[p+y]=Math.PI,s[g-y]=Math.PI;u[++c]=m,h<=f&&t(h,f,r)}else e++,w++,E++;for(x=Math.PI*(w-2)/w,_[++A]=n,v=o<0?0:o,b=1;b<=A;b++){for(k=_[b]-v,y=0;y<=k;y++)s[v+y]+=x;if(b>A)break;v=_[++b]}a[++l]=E}(0,n+1,t),a[l]-=2,r=0,o[0]=100,i[0]=100;var h=[];for(h.push([o[0],i[0]]),e=1;e<n;e++)o[e]=o[e-1]+15*Math.cos(r),i[e]=i[e-1]+15*Math.sin(r),h.push([o[e],i[e]]),r+=Math.PI-s[e+1];return h}function k(){this.radius=null,this.loopnumber=null,this.next=null,this.prev=null}void 0===String.prototype.trim&&(String.prototype.trim=function(){return String(this).replace(/^\s+|\s+$/g,"")}),k.prototype.getRadius=function(){return this.radius},k.prototype.setRadius=function(t){this.radius=t},k.prototype.getLoopnumber=function(){return this.loopnumber},k.prototype.setLoopnumber=function(t){this.loopnumber=t},k.prototype.getNext=function(){return this.next},k.prototype.setNext=function(t){this.next=t},k.prototype.getPrev=function(){return this.prev},k.prototype.setPrev=function(t){this.prev=t};var x=n(3),w=n(5);function A(){this.mate=null,this.x=null,this.y=null,this.extracted=null,this.region=new w.a}A.prototype.getMate=function(){return this.mate},A.prototype.setMate=function(t){this.mate=t},A.prototype.getX=function(){return this.x},A.prototype.setX=function(t){this.x=t},A.prototype.getY=function(){return this.y},A.prototype.setY=function(t){this.y=t},A.prototype.isExtracted=function(){return this.extracted},A.prototype.setExtracted=function(t){this.extracted=t},A.prototype.getRegion=function(){return this.region},A.prototype.setRegion=function(t){this.region=t};var E=n(4);function _(){this.ANUM=9999,this.MAXITER=500,this.bases=[],this.nbase=null,this.nregion=null,this.loop_count=null,this.root=new E.a,this.loops=[],this.regions=[],this.rlphead=new k,this.lencut=.8,this.RADIUS_REDUCTION_FACTOR=1.4,this.angleinc=null,this._h=null,this.HELIX_FACTOR=.6,this.BACKBONE_DISTANCE=27}function N(t){var e=null,n=null,r=null;if(t.getNconnection()<=1)return 0;if(t.isMark())return-1;t.setMark(!0),e=0,n=0;for(var o=0;null!=t.getConnection(o);o++)(r=N(t.getConnection(o).getLoop()))>=0&&(1==++e?n=r:n>r&&(n=r));return t.setMark(!1),n+1}function L(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this;n.options=Object.assign({editable:!1,zoomable:!0,animation:!0,displayAllLinks:!1,labelInterval:10,chargeDistance:110,friction:.35,middleCharge:-30,otherCharge:-30,linkDistanceMultiplier:15,initialSize:null,layout:"standard-polygonal",transitionDuration:500,maxNodeRadius:80},e),null!==n.options.initialSize?(n.options.svgW=n.options.initialSize[0],n.options.svgH=n.options.initialSize[1]):(n.options.svgW=300,n.options.svgH=300),n.linkStrengths={pseudoknot:0,proteinChain:0,chainChain:0,intermolecule:10,external:0,other:10},n.displayParameters={displayNumbering:!0,displayNodeOutline:!0,displayNodeLabel:!0,displayLinks:!0,displayPseudoknotLinks:!0,displayProteinLinks:!0,displayDirectionArrows:!0},n.colorScheme="structure",n.customColors={},n.rnas={},n.extraLinks=[];var o=null,s=null,u=!1,c=function(){o=null,s=null,null},d=n.graph={nodes:[],links:[]};if(Array.prototype.equals=function(t){if(!t)return!1;if(this.length!=t.length)return!1;for(var e=0,n=this.length;e<n;e++)if(this[e]instanceof Array&&t[e]instanceof Array){if(!this[e].equals(t[e]))return!1}else if(this[e]!=t[e])return!1;return!0},n.options.editable||n.options.animation){var f=!1,p=!1;a.a.select("body").on("keydown",function(){switch(a.a.event.keyCode){case 68:console.log("dotbracket:",n.getStructuresDotBracket());break;case 16:f=!0;break;case 17:p=!0;break;case 67:n.centerView()}p&&(n.options.zoomable&&M(),(n.options.editable||n.options.animation)&&I())}).on("keyup",function(){f=!1,p=!1,n.options.zoomable&&S(),B()}).on("contextmenu",function(){a.a.event.preventDefault()})}if(n.options.editable){var m=[{title:"Add Node",action:function(t,e,n,r){},children:[{title:"A",action:function(t,e,r,o){console.log("mousePos:",o,n.options.svgW,n.options.svgH);var i=[P.invert(o[0]),T.invert(o[1])];console.log("canvasMousePos",i),n.addRNA(".",{sequence:"A",centerPos:i})}},{title:"C",action:function(t,e,r,o){console.log("mousePos:",o,n.options.svgW,n.options.svgH);var i=[P.invert(o[0]),T.invert(o[1])];console.log("canvasMousePos",i),n.addRNA(".",{sequence:"C",centerPos:i})}},{title:"G",action:function(t,e,r,o){console.log("mousePos:",o,n.options.svgW,n.options.svgH);var i=[P.invert(o[0]),T.invert(o[1])];console.log("canvasMousePos",i),n.addRNA(".",{sequence:"G",centerPos:i})}},{title:"U",action:function(t,e,r,o){console.log("mousePos:",o,n.options.svgW,n.options.svgH);var i=[P.invert(o[0]),T.invert(o[1])];console.log("canvasMousePos",i),n.addRNA(".",{sequence:"U",centerPos:i})}}],disabled:!1}],k=[{title:"Delete Node",action:function(t,e,n){H(e)},disabled:!1},{title:"Change Node",action:function(t,e,n){console.log("You have clicked the second item!"),console.log("The data for this circle is: "+e)},children:[{title:"A",action:function(t,e,n){j("A",e)}},{title:"C",action:function(t,e,n){j("C",e)}},{title:"G",action:function(t,e,n){j("G",e)}},{title:"U",action:function(t,e,n){j("U",e)}}]},{title:"Insert Before",action:function(t,e,n){},children:[{title:"A",action:function(t,e,n){J("A",e,-1)}},{title:"C",action:function(t,e,n){J("C",e,-1)}},{title:"G",action:function(t,e,n){J("G",e,-1)}},{title:"U",action:function(t,e,n){J("U",e,-1)}}]},{title:"Insert After",action:function(t,e,n){console.log("d:",e)},children:[{title:"A",action:function(t,e,n){J("A",e,0)}},{title:"C",action:function(t,e,n){J("C",e,0)}},{title:"G",action:function(t,e,n){J("G",e,0)}},{title:"U",action:function(t,e,n){J("U",e,0)}}]}];n.nodeContextMenu=h(k),n.backgroundContextMenu=h(m)}else n.nodeContextMenu=function(){};a.a.select(t).select("svg").remove();var x=a.a.select(t).attr("tabindex",1).each(function(){this.focus()}).append("svg:svg").attr("preserveAspectRatio","xMidYMid meet").attr("viewBox","0 0 "+n.options.svgW+" "+n.options.svgH);if(n.options.svg=x,n.options.editable||n.options.animation)(w=x.append("svg:g").on("mousemove",function(){if(o){var t=a.a.mouse(A.node());L.attr("x1",o.x).attr("y1",o.y).attr("x2",t[0]).attr("y2",t[1])}}).on("mousedown",function(){}).on("mouseup",function(){o&&!u&&L.classed(i.a.transparent,!0),c()}).classed(i.a.mouseEventHelper,!0).style("pointer-events","all")).append("svg:rect").classed("background",!0).style("visibility","hidden").attr("width",n.options.svgW).attr("height",n.options.svgH).on("mousedown",function(){C()});else var w=x;var A=w.append("svg:g").classed(i.a.plot,!0),E=A.append("svg:g").classed("fornac-links",!0),N=A.append("svg:g").classed("fornac-nodes",!0);if(n.options.editable){var L=A.append("line").attr("class",i.a.dragLine).attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",0);x.on("contextmenu",n.backgroundContextMenu)}var P=a.a.scale.linear().domain([0,n.options.svgW]).range([0,n.options.svgW]),T=a.a.scale.linear().domain([0,n.options.svgH]).range([0,n.options.svgH]);n.zoomer=a.a.behavior.zoom().scaleExtent([.1,10]).x(P).y(T).on("zoom",function(){A.attr("transform","translate("+a.a.event.translate+") scale("+a.a.event.scale+")")});var S=function(){x.call(n.zoomer).on("dblclick.zoom",null)},M=function(){x.call(n.zoomer).on("dblclick.zoom",null).on("mousedown.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null).on("touchend.zoom",null)};n.options.zoomable&&S();var R=function(t){t.selected=!t.selected,N.selectAll("g.gnode").filter(function(e){return t.uid==e.uid}).classed(i.a.selectedNode,function(t){return t.selected})},C=function(){N.selectAll("g.gnode").classed(i.a.selectedNode,function(t){return t.selected=!1})},Y=function(){return N.selectAll("g.gnode").filter(function(t){return t.selected})};n.brusher=a.a.svg.brush().x(P).y(T).on("brushstart",function(t){}).on("brush",function(){var t=a.a.event.target.extent();N.selectAll("g.gnode").classed(i.a.selectedNode,function(e){return e.selected^(t[0][0]<=e.x&&e.x<t[1][0]&&t[0][1]<=e.y&&e.y<t[1][1])})}).on("brushend",function(){var t=a.a.event.target.extent();N.selectAll("g.gnode").filter(function(e){return t[0][0]<=e.x&&e.x<t[1][0]&&t[0][1]<=e.y&&e.y<t[1][1]}).each(R),a.a.event.target.clear(),a.a.select(this).call(a.a.event.target)});var I=function(){w.select(".background").style("cursor","crosshair"),w.call(n.brusher)},B=function(){w.select(".background").style("cursor","auto"),w.call(n.brusher).on("mousedown.brush",null).on("touchstart.brush",null).on("touchmove.brush",null).on("touchend.brush",null)};n.force=a.a.layout.force().charge(function(t){return"middle"==t.nodeType?n.options.middleCharge:n.options.otherCharge}).friction(n.options.friction).linkDistance(function(t){return n.options.linkDistanceMultiplier*t.value}).linkStrength(function(t){return t.linkType in n.linkStrengths?n.linkStrengths[t.linkType]:n.linkStrengths.other}).gravity(0).nodes(n.graph.nodes).links(n.graph.links).chargeDistance(n.options.chargeDistance).size([n.options.svgW,n.options.svgH]);var O=a.a.behavior.drag().on("dragstart",function(t){console.log("dragstart"),a.a.event.sourceEvent.stopPropagation(),Y().each(function(t){t.fixed|=2})}).on("drag",function(t){f||(Y().each(function(t){t.x+=a.a.event.dx,t.y+=a.a.event.dy,t.px+=a.a.event.dx,t.py+=a.a.event.dy}),n.resumeForce(),a.a.event.sourceEvent.preventDefault())}).on("dragend",function(t){console.log("dragend"),Y().each(function(t){t.fixed&=-7})}),U=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={sequence:"",name:"empty",positions:[],labelInterval:n.options.labelInterval,avoidOthers:!0,uids:[],circularizeExternal:!0},o=new v((r=Object.assign(r,e)).sequence,t,r.name);o.circularizeExternal=r.circularizeExternal;var i=o.recalculateElements();if(0===r.positions.length)if("naview"==n.options.layout){var s=(new _).naview_xy_coordinates(o.pairtable);r.positions=[];for(var a=0;a<s.nbase;a++)r.positions.push([s.x[a],s.y[a]])}else r.positions=b(i.pairtable);return i=i.elementsToJson().addUids(r.uids).addPositions("nucleotide",r.positions).addLabels(1,r.labelInterval).reinforceStems().reinforceLoops().connectFakeNodes().reassignLinkUids().breakNodesToFakeNodes()},X=function(t){(t=t.append("g").classed("gnode",!0).attr("struct_name",function(t){return t.structName}).attr("transform",function(t){return void 0!==t.x&&void 0!==t.y?"translate("+[t.x,t.y]+")":""}).each(function(t){t.selected=t.previouslySelected=!1})).attr("num",function(t){return"n"+t.num}).attr("rnum",function(t){return"n"+(t.rna.rnaLength-t.num+1)}).transition().duration(750).ease("elastic"),(n.options.editable||n.options.animation)&&t.on("mousedown",Q).on("mouseup",Z).on("contextmenu",n.nodeContextMenu).call(O);var e=t.filter(function(t){return"label"==t.nodeType||"protein"==t.nodeType}),r=t.filter(function(t){return"nucleotide"==t.nodeType});return e.append("svg:circle").classed(i.a.node,!0).attr("r",function(t){return"middle"==t.nodeType?0:t.radius}).attr("node_type",function(t){return t.nodeType}).attr("node_num",function(t){return t.num}),r.append("svg:path").attr("class",i.a.directionArrow).attr("node_num",function(t){return t.num}),r.append("svg:circle").attr("class",i.a.node).attr("node_type",function(t){return t.nodeType}).attr("node_num",function(t){return t.num}).attr("r",function(t){return t.radius}).append("svg:title").text(function(t){return"nucleotide"==t.nodeType?t.structName+":"+t.num:""}),t.append("text").text(function(t){return t.name}).attr("class",i.a.nodeLabel).attr("label_type",function(t){return t.nodeType}).append("svg:title").text(function(t){return"nucleotide"==t.nodeType?t.structName+":"+t.num:""}),t},D=function(t){var e=t.append("svg:line");return e.append("svg:title").text(function(t){return t.linkType+":"+t.source.num+"-"+t.target.num}),e.classed("link",!0).classed(i.a.link,!0).attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}).attr("link_type",function(t){return t.linkType}).attr("pointer-events",function(t){return"fake"==t.linkType?"none":"all"}),n.options.editable&&e.on("click",$),e};function q(t){var e=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])},n=t,r=t.prevNode,o=parseFloat(i.a.nodeStrokeWidth)/2,s=parseFloat(i.a.directionArrowSize),u=parseFloat(i.a.directionArrowWidth);if(null!==r&&t.linked){var l=[-(n.x-r.x),-(n.y-r.y)];if(0!=l[0]||0!=l[1]){var c=[-(l=[l[0]/e(l),l[1]/e(l)])[1],l[0]],d=[(t.radius+o)*l[0],(t.radius+o)*l[1]],h="M"+(d[0]+s*(l[0]/2+c[0]*u/2))+","+(d[1]+s*(l[1]/2+c[1]*u/2))+"L"+d[0]+","+d[1]+"L"+(d[0]+s*(l[0]/2-c[0]*u/2))+","+(d[1]+s*(l[1]/2-c[1]*u/2));a.a.select(this).attr("d",h)}}}var z=function(t){return"basepair"==t.linkType||"backbone"==t.linkType||"intermolecule"==t.linkType||"pseudoknot"==t.linkType||"label_link"==t.linkType||"external"==t.linkType||"chain_chain"==t.linkType},F=function(){for(var t in n.graph.nodes=[],n.graph.links=[],n.rnas)n.graph.nodes=n.graph.nodes.concat(n.rnas[t].nodes),n.graph.links=n.graph.links.concat(n.rnas[t].links);for(var e={},r=0;r<n.graph.nodes.length;r++)e[n.graph.nodes[r].uid]=n.graph.nodes[r];n.graph.links.forEach(function(t){t.source=e[t.source.uid],t.target=e[t.target.uid]});for(var o=function(t){if(!(n.extraLinks[t].target.uid in e))return console.log("not there:",n.extraLinks[t]),"continue";if(n.extraLinks[t].source=e[n.extraLinks[t].source.uid],n.extraLinks[t].target=e[n.extraLinks[t].target.uid],"intermolecule"==n.extraLinks[t].linkType)for(var r=n.graph.links.filter(function(e){return(e.source==n.extraLinks[t].source||e.source==n.extraLinks[t].target||e.target==n.extraLinks[t].source||e.target==n.extraLinks[t].source)&&"fake"==e.linkType}),o=0;o<r.length;o++){var i=n.graph.links.indexOf(r[o]);n.graph.links.splice(i,1)}d.links.push(n.extraLinks[t])},i=0;i<n.extraLinks.length;i++)o(i)};n.update=function(){n.force.nodes(n.graph.nodes).links(n.graph.links),n.options.animation&&n.force.start();var t=E.selectAll("line.link").data(n.graph.links.filter(z),W);t.attr("class","").classed("link",!0).classed(i.a.link,!0).attr("link_type",function(t){return t.linkType});var e=t.enter();D(e),t.exit().remove();var r=N.selectAll("g.gnode").data(n.graph.nodes,W),o=r.enter();X(o),r.exit().remove();var s=n.graph.nodes.filter(function(t){return"nucleotide"==t.nodeType||"label"==t.nodeType});r.select("."+i.a.directionArrow).each(q),n.force.on("tick",function(){for(var e=a.a.geom.quadtree(s),n=0,o=s.length,u=function(t){var e=t.radius+16,n=t.x-e,r=t.x+e,o=t.y-e,i=t.y+e;return function(e,s,a,u,l){if(e.point&&e.point!==t){var c=t.x-e.point.x,d=t.y-e.point.y,h=Math.sqrt(c*c+d*d),f=t.radius+e.point.radius;h<f&&(h=(h-f)/h*.1,t.x-=c*=h,t.y-=d*=h,e.point.x+=c,e.point.y+=d)}return s>r||u<n||a>i||l<o}};++n<o;)e.visit(u(s[n]));t.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),r.attr("transform",function(t){return"translate("+[t.x,t.y]+")"}),r.select("."+i.a.directionArrow).each(q)}),n.force.on("end",function(){r.selectAll("[node_type=nucleotide]").filter(function(t,e){return 0==e}).each(function(t,e){})}),n.changeColorScheme(n.colorScheme),n.options.animation&&n.force.start(),V()},n.transitionRNA=function(t,e){var r=n.options.transitionDuration,o=n.graph.nodes.filter(function(t){return"nucleotide"==t.nodeType}).map(function(t){return t.uid}),s=U(t,{uids:o}),a=N.selectAll("g.gnode").data(s.nodes,W),u=E.selectAll("line.link").data(s.links.filter(z),W);0===r?a.attr("transform",function(t){return"translate("+[t.x,t.y]+")"}):a.transition().attr("transform",function(t){return"translate("+[t.x,t.y]+")"}).duration(r);var l=X(a.enter()).attr("transform",function(t){return void 0!==t.x&&void 0!==t.y?"translate("+[0,0]+")":""});if(0===r?a.exit().remove():a.exit().transition().attr("transform",function(t){return void 0!==t.x&&void 0!==t.y?"translate("+[0,0]+")":""}),n.graph.nodes=a.data(),a.select("."+i.a.directionArrow).each(q),n.changeColorScheme(n.colorScheme),V(),n.centerView(r),u.exit().remove(),0===r){u.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y});D(u.enter());n.graph.links=u.data(),V()}else u.transition().attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}).duration(r).call(function(t,e){0===t.size()&&setTimeout(e,r);var n=0;t.each(function(){++n}).each("end",function(){--n||e.apply(this,arguments)})},function(){D(u.enter()),n.graph.links=u.data(),n.changeColorScheme(n.colorScheme),V(),void 0!==e&&e()});0===r?l.attr("transform",function(t){return void 0!==t.x&&void 0!==t.y?"translate("+[t.x,t.y]+")":""}):l.transition().attr("transform",function(t){return void 0!==t.x&&void 0!==t.y?"translate("+[t.x,t.y]+")":""})};n.centerView=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=function(){if(0===n.graph.nodes.length)return{translate:[0,0],scale:1};var t=a.a.min(n.graph.nodes.map(function(t){return t.x})),e=a.a.min(n.graph.nodes.map(function(t){return t.y})),r=a.a.max(n.graph.nodes.map(function(t){return t.x})),o=a.a.max(n.graph.nodes.map(function(t){return t.y})),i=a.a.max(n.graph.nodes.map(function(t){return t.radius})),s=r-t,u=o-e,l=n.options.svgW/(s+1),c=n.options.svgH/(u+1),d=.8*Math.min(l,c,n.options.maxNodeRadius/i),h=s*d,f=u*d;return{translate:[-t*d+(n.options.svgW-h)/2,-e*d+(n.options.svgH-f)/2],scale:d}}();null!==e&&(A.transition().attr("transform","translate("+e.translate+") scale("+e.scale+")").duration(t),n.zoomer.translate(e.translate),n.zoomer.scale(e.scale))},n.setSize=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.a.select(t).node().offsetWidth,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.a.select(t).node().offsetHeight;n.options.svgW=e,n.options.svgH=r,x.attr("viewBox","0 0 "+e+" "+r),P.range([0,e]).domain([0,e]),T.range([0,r]).domain([0,r]),n.zoomer.x(P).y(T),n.brusher.x(P).y(T),x.select(".background").attr("width",e).attr("height",r),n.centerView()},n.setOutlineColor=function(t){N.selectAll("g.gnode").select("[node_type=nucleotide]").style("fill",t)},n.addCustomColors=function(t){n.customColors=t,n.changeColorScheme("custom")},n.addCustomColorsText=function(t){var e=new y(t);n.customColors=e.colorsJson,n.changeColorScheme("custom")},n.changeColorScheme=function(t){N.selectAll("[node_type=protein]").classed(i.a.node,!0).attr("r",function(t){return t.radius});N.selectAll("g.gnode"),N.selectAll("g.gnode").selectAll("circle");var e=N.selectAll("g.gnode").select("[node_type=nucleotide]");if(n.colorScheme=t,"sequence"==t){var r=a.a.scale.ordinal().range(["#dbdb8d","#98df8a","#ff9896","#aec7e8","#aec7e8"]).domain(["A","C","G","U","T"]);e.style("fill",function(t){return r(t.name)})}else if("structure"==t){r=a.a.scale.category10().domain(["s","m","i","e","t","h","x"]).range(["lightgreen","#ff9896","#dbdb8d","lightsalmon","lightcyan","lightblue","transparent"]);e.style("fill",function(t){return r(t.elemType)})}else if("positions"==t)e.style("fill",function(t){return a.a.scale.linear().range(["#98df8a","#dbdb8d","#ff9896"]).interpolate(a.a.interpolateLab).domain([1,1+(t.rna.rnaLength-1)/2,t.rna.rnaLength])(t.num)});else if("custom"==t){if(void 0!==n.customColors&&"domain"in n.customColors&&"range"in n.customColors)r=a.a.scale.linear().interpolate(a.a.interpolateLab).domain(n.customColors.domain).range(n.customColors.range);var o=function(t,e,n){if(t.hasOwnProperty(e.num)){var r=parseFloat(t[e.num]);return isNaN(r)?t[e.num]:n(r)}return"white"};e.style("fill",function(t){if(void 0===n.customColors||!n.customColors.hasOwnProperty("colorValues"))return"white";if(n.customColors.colorValues.hasOwnProperty(t.structName)&&n.customColors.colorValues[t.structName].hasOwnProperty(t.num)){var e=n.customColors.colorValues[t.structName];return o(e,t,r)}if(n.customColors.colorValues.hasOwnProperty("")){var i=n.customColors.colorValues[""];return o(i,t,r)}return"white"})}};var V=function(){N.selectAll("[node_type=label]").classed(i.a.transparent,!n.displayParameters.displayNumbering),N.selectAll("[label_type=label]").classed(i.a.transparent,!n.displayParameters.displayNumbering),E.selectAll("[link_type=label_link]").classed(i.a.transparent,!n.displayParameters.displayNumbering),x.selectAll("[node_type=nucleotide]").classed(i.a.transparent,!n.displayParameters.displayNodeOutline),N.selectAll("[label_type=nucleotide]").classed(i.a.transparent,!n.displayParameters.displayNodeLabel),x.selectAll("[link_type=real],[link_type=basepair],[link_type=backbone],[link_type=pseudoknot],[link_type=protein_chain],[link_type=chain_chain],[link_type=external]").classed(i.a.transparent,!n.displayParameters.displayLinks),x.selectAll("[link_type=pseudoknot]").classed(i.a.transparent,!n.displayParameters.displayPseudoknotLinks),x.selectAll("[link_type=protein_chain]").classed(i.a.transparent,!n.displayParameters.displayProteinLinks),E.selectAll("[link_type=fake]").classed(i.a.transparent,!n.options.displayAllLinks),E.selectAll("[link_type=fake_fake]").classed(i.a.transparent,!n.options.displayAllLinks),x.selectAll("."+i.a.directionArrow).classed(i.a.transparent,!n.displayParameters.displayDirectionArrows)},j=function(t,e){var r=e.rna,o=g.pairtableToDotbracket(r.pairtable),i=r.getPositions("nucleotide"),s=r.seq,a=r.getUids(),u=e.num,c=o,d=s.slice(0,u-1)+t+s.slice(u);console.log("newSequence:",d),console.log("uids:",a),a.splice(u-1,1,l.a.nice());var h=i;delete n.rnas[r.uid];n.addRNA(c,{sequence:d,positions:h,uids:a,centerView:!1})},J=function(t,e,r){var o=e.rna,i=g.pairtableToDotbracket(o.pairtable),s=o.getPositions("nucleotide"),a=o.seq,u=o.getUids(),c=e.num+r,d=i.slice(0,c)+"."+i.slice(c),h=a.slice(0,c)+t+a.slice(c);console.log("newSequence:",h),u.splice(c,0,l.a.nice()),s.splice(c,0,s[c-r-1]);var f=u,p=s;console.log("positions:",s),console.log("new node positions:",p),delete n.rnas[o.uid];n.addRNA(d,{sequence:h,positions:p,uids:f,centerView:!1})},H=function(t){console.log("deleting...",t);var e=t.rna,r=e.pairtable[t.num];0!=r&&(e.pairtable[t.num]=0,e.pairtable[r]=0);var o=g.pairtableToDotbracket(e.pairtable),i=e.getPositions("nucleotide"),s=e.seq,a=e.getUids(),u=o.slice(0,t.num-1)+o.slice(t.num),l=i.slice(0,t.num-1).concat(i.slice(t.num)),c=s.slice(0,t.num-1)+s.slice(t.num),d=a.slice(0,t.num-1).concat(a.slice(t.num));delete n.rnas[e.uid];n.addRNA(u,{sequence:c,positions:l,uids:d,centerView:!1});console.log("new dotbracket:",u)},W=function(t){return t.uid},G=function(t){var e=t.getPositions("nucleotide"),r=t.getPositions("label"),o=t.getUids();t.recalculateElements().elementsToJson().addPseudoknots().addPositions("nucleotide",e).addUids(o).addLabels(1,n.options.labelInterval).addPositions("label",r).reinforceStems().reinforceLoops().updateLinkUids()},K=function(t){var e=n.graph.links.indexOf(t);if(console.log("removing link:",e),e>-1){if(t.source.rna==t.target.rna){if("backbone"==t.linkType)return console.log("trying to remove a backbone link",t.source.num,t.target.num),void function(t){if(t.target.num-t.source.num==1){for(var e=t.target.rna,r=[],o=0;o<e.links.length;o++){var i=e.links[o];"basepair"==i.linkType&&i.source.num<=t.source.num&&i.target.num>=t.target.num&&(console.log("crossing basepair",i),r.push(i))}console.log("toRemove:",r);for(var s=0;s<r.length;s++)e.pairtable[r[s].source.num]=0,e.pairtable[r[s].target.num]=0,r[s].from=r[s].source.num,r[s].to=r[s].target.num-t.source.num;e.seq;var a=e.seq.slice(0,t.source.num),u=e.seq.slice(t.source.num),c=g.pairtableToDotbracket(e.pairtable),d=c.slice(0,t.source.num),h=c.slice(t.source.num),f=e.getPositions("nucleotide"),p=e.getUids(),y=f.slice(0,t.source.num),m=f.slice(t.source.num),v=p.slice(0,t.source.num),b=p.slice(t.source.num);console.log("positions1:",y),console.log("positions2:",m),delete n.rnas[e.uid];for(var k=n.addRNA(d,{sequence:a,positions:y,uids:v}),x=n.addRNA(h,{sequence:u,positions:m,uids:b}),w=0;w<r.length;w++)console.log("rna1:",k),console.log("rna2:",x),console.log("toRemove[i]",r[w]),n.extraLinks.push({source:k.nodes[r[w].from-1],target:x.nodes[r[w].to-1],value:1,uid:l.a.nice(),linkType:"intermolecule"}),F(),n.update();console.log("self.extraLinks:",n.extraLinks)}else console.log("ERROR: non adjacent nodes. Target:",t.target,"Source:",t.source,"Link:",t)}(t);var r=t.source.rna;r.addPseudoknots(),r.pairtable[t.source.num]=0,r.pairtable[t.target.num]=0,G(r)}else{var o=n.extraLinks.indexOf(t);n.extraLinks.splice(o,1)}F()}n.update()};var Z=function(t,e){console.log("nodeMouseup");var r=!0;if(o){if("middle"==(s=t).nodeType||"middle"==o.nodeType||"label"==s.nodeType||"label"==o.nodeType)return;if(s==o)return void c();for(var a={source:o,target:s,linkType:"basepair",value:1,uid:l.a.nice()},d=0;d<n.graph.links.length;d++)if(n.graph.links[d].source!=o&&n.graph.links[d].target!=o&&n.graph.links[d].source!=s&&n.graph.links[d].target!=s||"basepair"!=n.graph.links[d].linkType&&"pseudoknot"!=n.graph.links[d].linkType&&"intermolecule"!=n.graph.links[d].linkType||(console.log("no basepair possible"),r=!1),(n.graph.links[d].source==s&&n.graph.links[d].target==o||n.graph.links[d].source==o&&n.graph.links[d].target==s)&&"backbone"==n.graph.links[d].linkType)return;if(a.source.rna!=a.target.rna)if(1==a.source.num&&a.target.num==a.target.rna.rnaLength||1==a.target.num&&a.source.num==a.source.rna.rnaLength){var f=[{title:"Backbone Link",action:function(t,e,r){u=!1,console.log("Item #1 clicked!"),console.log("The data for this circle is: "+e),L.attr("class",i.a.transparent),function(t){var e=t.target.rna,r=t.source.rna;1==t.target.num&&(e=t.source.rna,r=t.target.rna);for(var o=g.pairtableToDotbracket(e.pairtable),i=g.pairtableToDotbracket(r.pairtable),s=e.seq,a=r.seq,u=e.getPositions("nucleotide"),c=r.getPositions("nucleotide"),d=o+i,h=s+a,f=u.concat(c),p=[],y={},m=0;m<n.extraLinks.length;m++)console.log("self.extraLinks[i]",n.extraLinks[m]),console.log("rna1:",e),console.log("rna2:",r),n.extraLinks[m].source.rna==e?n.extraLinks[m].target.rna==r||(p.push({source:n.extraLinks[m].target,target:n.extraLinks[m].source.num}),y[n.extraLinks[m].uid]=!0):n.extraLinks[m].source.rna==r&&(n.extraLinks[m].target.rna==e||(p.push({source:n.extraLinks[m].target,target:n.extraLinks[m].source.num+o.length}),y[n.extraLinks[m].uid]=!0)),n.extraLinks[m].target.rna==e?n.extraLinks[m].source.rna==r||(p.push({source:n.extraLinks[m].source,target:n.extraLinks[m].target.num}),y[n.extraLinks[m].uid]=!0):n.extraLinks[m].target.rna==r&&n.extraLinks[m].source.rna==e&&(p.push({source:n.extraLinks[m].source,target:n.extraLinks[m].target.num+o.length}),y[n.extraLinks[m].uid]=!0);n.extraLinks=n.extraLinks.filter(function(t){return!(t.uid in y)}),delete n.rnas[e.uid],delete n.rnas[r.uid];var v=null;v=n.options.animation?n.addRNA(d,{sequence:h,positions:f,centerView:!1}):n.addRNA(d,{sequence:h,centerView:!1});for(var b=0;b<p.length;b++)n.extraLinks.push({source:p[b].source,target:v.nodes[p[b].target-1],value:1,uid:l.a.nice(),linkType:"intermolecule"});F(),n.update(),console.log("self.extraLinks:",n.extraLinks)}(a)},disabled:!1},{title:"Basepair Link",action:function(t,e,r){u=!1,console.log("You have clicked the second item!"),console.log("The data for this circle is: "+e),L.attr("class",i.a.transparent),n.addLink(a)}}];u=!0;var p=h(f);console.log("newLinkMenu"),p.apply(this,[t,e,!0,function(){L.attr("class",i.a.transparent)}])}else r&&n.addLink(a);else r&&n.addLink(a)}},Q=function(t){console.log("nodeMousedown"),t.selected||p||C(),f||(p?R(t):function(t){t.selected=!0,N.selectAll("g.gnode").filter(function(e){return t.uid==e.uid}).classed(i.a.selectedNode,function(t){return t.selected})}(t)),f&&n.options.editable&&(o=t,L.attr("class",i.a.dragLine).attr("x1",o.x).attr("y1",o.y).attr("x2",o.x).attr("y2",o.y),a.a.event.stopPropagation())},$=function(t){if(f){console.log("d.linkType:",t.linkType),t.linkType in{fake:!0,fake_fake:!0,label_link:!0}||K(t)}};n.toJSON=function(){var t={rnas:n.rnas,extraLinks:n.extraLinks};return JSON.stringify(t,function(t,e){return"rna"==t?void 0:e},"\t")},n.fromJSON=function(t){var e,o;try{var i=JSON.parse(t);e=i.rnas,o=i.extraLinks}catch(t){throw t}for(var s in e)"rna"==e[s].type?(r=new v,r.seq=e[s].seq,r.dotbracket=e[s].dotbracket,r.circular=e[s].circular,r.pairtable=e[s].pairtable,r.uid=e[s].uid,r.structName=e[s].structName,r.nodes=e[s].nodes,r.links=e[s].links,r.rnaLength=e[s].rnaLength,r.elements=e[s].elements,r.nucsToNodes=e[s].nucsToNodes,r.pseudoknotPairs=e[s].pseudoknotPairs):(r=new ProteinGraph,r.size=e[s].size,r.nodes=e[s].nodes,r.uid=e[s].uid),n.addRNAJSON(r,!1);o.forEach(function(t){n.extraLinks.push(t)}),F(),n.update()},n.addRNA=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=U(t,e);if("extraLinks"in e){var o=n.addExternalLinks(r,e.extraLinks);n.extraLinks=n.extraLinks.concat(o)}return"centerPos"in e?n.addRNAJSON(r,{centerPos:e.centerPos,centerView:!1}):"avoidOthers"in e?n.addRNAJSON(r,{avoidOthers:e.avoidOthers}):n.addRNAJSON(r,{centerView:e.centerView}),r},n.addRNAJSON=function(t,e){var r,o,i=e.avoidOthers,s=void 0!==i&&i,u=e.centerPos,l=void 0===u?null:u,c=e.centerView,d=void 0===c||c;if(null!=l){var h=0,f=0,p=0;t.nodes.forEach(function(t){h+=t.x,f+=t.y,p+=1}),p>0&&t.nodes.forEach(function(t){t.x=t.x+l[0]-h/p,t.y=t.y+l[1]-f/p,t.px=t.x,t.py=t.y})}return s&&(r=n.graph.nodes.length>0?a.a.max(n.graph.nodes.map(function(t){return t.x})):0,o=a.a.min(t.nodes.map(function(t){return t.x})),t.nodes.forEach(function(t){t.x+=r-o+20,t.px+=r-o})),t.nodes.forEach(function(e){e.rna=t}),n.rnas[t.uid]=t,F(),n.update(),d&&n.centerView(),t},n.addNodes=function(t){t.links.forEach(function(e){"number"==typeof e.source&&(e.source=t.nodes[e.source]),"number"==typeof e.target&&(e.target=t.nodes[e.target])}),n.graph.nodes.length>0?(maxX=a.a.max(n.graph.nodes.map(function(t){return t.x})),maxY=a.a.max(n.graph.nodes.map(function(t){return t.y}))):(maxX=0,maxY=0),t.nodes.forEach(function(t){t.rna.uid in n.rnas||(n.rnas[t.rna.uid]=t.rna),t.x+=maxX,t.px+=maxX}),r=new v("",""),r.nodes=t.nodes,r.links=t.links,F(),n.update(),n.centerView()},n.clearNodes=function(){n.graph.nodes=[],n.graph.links=[],n.rnas={},n.extraLinks=[],n.update()},n.addLink=function(t){if(console.log("adding new link"),t.source.rna==t.target.rna){var e=t.source.rna;e.pairtable[t.source.num]=t.target.num,e.pairtable[t.target.num]=t.source.num,G(e)}else console.log("intermolecule"),t.linkType="intermolecule",n.extraLinks.push(t);F(),n.update()},n.addExternalLinks=function(t,e){for(var n=[],r=0;r<e.length;r++){var o={linkType:"external",value:1,uid:l.a.nice(),source:null,target:null};if("[object Array]"===Object.prototype.toString.call(e[r][0])){for(var i=0;i<t.nodes.length;i++)if("nucs"in t.nodes[i]&&t.nodes[i].nucs.equals(e[r][0])){o.source=t.nodes[i];break}}else for(var s=0;s<t.nodes.length;s++)t.nodes[s].num==e[r][0]&&(o.source=t.nodes[s]);if("[object Array]"===Object.prototype.toString.call(e[r][1]))for(var a=0;a<t.nodes.length;a++)"nucs"in t.nodes[a]&&t.nodes[a].nucs.equals(e[r][1])&&(o.target=t.nodes[a]);else for(var u=0;u<t.nodes.length;u++)t.nodes[u].num==e[r][1]&&(o.target=t.nodes[u]);null!=o.source&&null!=o.target?n.push(o):console.log("ERROR: source or target of new link not found:",o,e[r])}return n},n.getStructuresDotBracket=function(){console.log("self.rnas:",n.rnas);var t=[],e=1,r={},o=[],i=[];for(var s in n.rnas){for(var a=n.rnas[s],u=0;u<a.nodes.length;u++){var l=a.nodes[u];"nucleotide"==l.nodeType&&(console.log("node:",l),r[l.uid]=e,e+=1,t.push(l.name))}o.push(e)}i=[e-1];for(var c=0;c<e;c++)i.push(0);for(var d in n.rnas)for(var h=n.rnas[d],f=0;f<h.links.length;f++){var p=h.links[f];if("basepair"==p.linkType){var y=r[p.source.uid],m=r[p.target.uid];i[y]=m,i[m]=y}}for(var v=0;v<n.extraLinks.length;v++){var b=n.extraLinks[v],k=r[b.source.uid],x=r[b.target.uid];i[k]=x,i[x]=k}for(var w=g.pairtableToDotbracket(i).split(""),A=0;A<o.length-1;A++)console.log("breaks[i]:",o[A]),t.splice(o[A]+A-1,0,"&"),w.splice(o[A]+A-1,0,"&");return console.log("sequence:",t,t.join("")),console.log("structure:",w,w.join("")),[t.join(""),w.join("")]},n.startAnimation=function(){n.options.animation=!0,A.selectAll("g.gnode").call(O),n.force.start()},n.stopAnimation=function(){n.options.animation=!1,A.selectAll("g.gnode").on("mousedown.drag",null),n.force.stop()},n.resumeForce=function(){n.options.animation&&n.force.resume()},n.setFriction=function(t){n.force.friction(t),n.resumeForce()},n.setCharge=function(t){n.force.charge(t),n.resumeForce()},n.setGravity=function(t){n.force.gravity(t),n.resumeForce()},n.setPseudoknotStrength=function(t){n.linkStrengths.pseudoknot=t,n.update()},n.displayNumbering=function(t){n.displayParameters.displayNumbering=t,V()},n.displayNodeOutline=function(t){n.displayParameters.displayNodeOutline=t,V()},n.displayNodeLabel=function(t){n.displayParameters.displayNodeLabel=t,V()},n.displayLinks=function(t){n.displayParameters.displayLinks=t,V()},n.displayPseudoknotLinks=function(t){n.displayParameters.displayPseudoknotLinks=t,V()},n.displayProteinLinks=function(t){n.displayParameters.displayProteinLinks=t,V()},n.displayDirectionArrows=function(t){n.displayParameters.displayDirectionArrows=t,V()}}function P(){var t,e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r={width:300,height:300,nucleotideRadius:5,rnaEdgePadding:1,labelInterval:10,showNucleotideLabels:!0,startNucleotideNumber:1,bundleExternalLinks:!1,rnaLayout:"simple",namePosition:"0 0"};r=Object.assign(r,n);function o(n){n.each(function(n){var o=d3.select(this).append("g").classed(i.a.plot,!0),s=new v(n.sequence,n.structure,n.name,r.startNucleotideNumber).recalculateElements().elementsToJson().addName(n.name);n.rnaGraph=s;var a=[];if("naview"===r.rnaLayout)for(var u=(new _).naview_xy_coordinates(s.pairtable),l=0;l<u.nbase;l++)a.push([u.x[l],u.y[l]]);else a=b(s.pairtable);s.addPositions("nucleotide",a).addLabels(r.startNucleotideNumber,r.labelInterval);var c=function(n,o){var i=d3.extent(n),s=d3.extent(o);i[0]-=r.nucleotideRadius+r.rnaEdgePadding,s[0]-=r.nucleotideRadius+r.rnaEdgePadding,i[1]+=r.nucleotideRadius+r.rnaEdgePadding,s[1]+=r.nucleotideRadius+r.rnaEdgePadding;var a,u=i[1]-i[0],l=s[1]-s[0];function c(t,e,n){var r=(t.range()[1]-t.range()[0])/(t.domain()[1]-t.domain()[0]),o=(e[1]-e[0])*r,i=(n[1]-n[0]-o)/2;return{scaleFactor:r,scale:d3.scale.linear().domain(e).range([n[0]+i,n[1]-i])}}return u-r.width>l-r.height?(a=c(t=d3.scale.linear().domain(i).range([0,r.width]),s,[0,r.height]),e=a.scale):(a=c(e=d3.scale.linear().domain(s).range([0,r.height]),i,[0,r.width]),t=a.scale),t.range()[0],t.domain()[0],e.range()[0],e.domain()[0],"translate("+-(t.domain()[0]*a.scaleFactor-t.range()[0])+","+-(e.domain()[0]*a.scaleFactor-e.range()[0])+")scale("+a.scaleFactor+")"}(s.nodes.map(function(t){return t.x}),s.nodes.map(function(t){return t.y}));o.attr("transform",c);var d=s.nodes.filter(function(t){return"nucleotide"==t.nodeType}),h=s.nodes.filter(function(t){return"label"==t.nodeType}),f=s.links;!function(t,e){e=e.filter(function(t){return null!==t.source&&null!==t.target}),t.selectAll(".link").data(e).enter().append("svg:line").attr("x1",function(t){return t.source.x}).attr("x2",function(t){return t.target.x}).attr("y1",function(t){return t.source.y}).attr("y2",function(t){return t.target.y}).attr("link-type",function(t){return t.linkType}).attr("extra-link-type",function(t){return t.extraLinkType}).classed("link",!0).classed(i.a.link,!0)}(o,f),function(t,e){var n=t.selectAll(".gnode").data(e).enter().append("svg:g").classed("gnode",!0).attr("transform",function(t){return"translate("+t.x+","+t.y+")"});n.append("svg:circle").classed(i.a.node,!0).attr("node_type","nucleotide").attr("base_type",function(t){if(t.name)return t.name.toLowerCase()}).attr("r",r.nucleotideRadius),r.showNucleotideLabels&&n.append("svg:text").text(function(t){return t.name}).classed(i.a.nodeLabel,!0).append("svg:title").text(function(t){return t.struct_name+":"+t.num})}(o,d),function(t,e){var n=t.selectAll().data(e).enter().append("svg:g").classed("gnode",!0).attr("transform",function(t){return"translate("+t.x+","+t.y+")"});n.append("svg:circle").classed(i.a.node,!0).attr("node_type","label").attr("r",r.nucleotideRadius),n.append("svg:text").classed(i.a.nodeLabel,!0).text(function(t){return t.name})}(o,h),function(t,e){var n=t.append("svg:text").classed(i.a.plotLabel,!0).text(e),o=r.namePosition.split(" ",2),s=[],a=n.node().getBBox(),u=[a.width,a.height],l=[r.width,r.height];for(var c in[0,1])switch(o[c]){case"0":s[c]=u[c]/2;break;case"1":s[c]=l[c]-u[c]/2;break;case"0.5":s[c]=l[c]/2}n.attr("x",s[0]).attr("y",s[1])}(d3.select(this),n.name),r.bundleExternalLinks&&function(t,e){var n={},r=[];e=e.filter(function(t){return"correct"==t.linkType||"incorrect"==t.linkType||"extra"==t.linkType}),t.selectAll("[link-type=extra]").remove();for(var o=0;o<e.length;o++)null!==e[o].source&&null!==e[o].target&&(n[e[o].source.uid]=e[o].source,n[e[o].target.uid]=e[o].target,r.push({source:e[o].source.uid,target:e[o].target.uid,linkType:e[o].linkType,extraLinkType:e[o].extraLinkType}));var i=d3.ForceEdgeBundling().nodes(n).edges(r).compatibility_threshold(.8).step_size(.2)(),s=d3.svg.line().x(function(t){return t.x}).y(function(t){return t.y}).interpolate("linear");for(o=0;o<i.length;o++){var a=i[o];t.append("path").attr("d",s(a)).style("fill","none").attr("link-type",function(t){return r[o].linkType}).attr("extra-link-type",function(t){return r[o].extraLinkType}).style("stroke-opacity",.4)}}(o,f)})}return o.width=function(t){return arguments.length?(r.width=t,o):r.width},o.height=function(t){return arguments.length?(r.height=t,o):r.height},o.showNucleotideLabels=function(t){return arguments.length?(r.showNucleotideLabels=t,o):r.showNucleotideLabels},o.rnaEdgePadding=function(t){return arguments.length?(r.rnaEdgePadding=t,o):r.rnaEdgePadding},o.nucleotideRadius=function(t){return arguments.length?(r.nucleotideRadius=t,o):r.nucleotideRadius},o.labelInterval=function(t){return arguments.length?(r.labelInterval=t,o):r.labelInterval},o.showNucleotideLabels=function(t){return arguments.length?(r.showNucleotideLabels=t,o):r.showNucleotideLabels},o.startNucleotideNumber=function(t){return arguments.length?(r.startNucleotideNumber=t,o):r.startNucleotideNumber},o.bundleExternalLinks=function(t){return arguments.length?(r.bundleExternalLinks=t,o):r.bundleExternalLinks},o.rnaLayout=function(t){return arguments.length?(r.rnaLayout=t,o):r.rnaLayout},o.namePosition=function(t){return arguments.length?(r.namePosition=t,o):r.namePosition},o}function T(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e={width:300,height:300,nucleotideRadius:5,rnaEdgePadding:1,labelInterval:10,showNucleotideLabels:!0,startNucleotideNumber:1,bundleExternalLinks:!1,rnaLayout:"simple",namePosition:"0 0"};e=Object.assign(e,t);function n(t){t.each(function(t){d3.select(this).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).append("rect").attr("fill","transparent").attr("width",function(t){return Math.max(0,t.dx)}).attr("height",function(t){return Math.max(0,t.dy)});var n=P(e).width(Math.max(0,t.dx)).height(Math.max(0,t.dy));"structure"in t&&d3.select(this).call(n)})}var r=function(t){t.each(function(t){console.log("data:",t);var r=d3.layout.treemap().size([e.width,e.height]).sticky(!1).value(function(t){return t.size});d3.select(this).append("g").classed("rnatreemap",!0).datum(t).selectAll(".treemapnode").data(r.nodes).enter().append("g").classed("treemapnode",!0).call(n)})};return r.width=function(t){return arguments.length?(e.width=t,r):e.width},r.height=function(t){return arguments.length?(e.height=t,r):e.height},r.showNucleotideLabels=function(t){return arguments.length?(e.showNucleotideLabels=t,r):e.showNucleotideLabels},r.rnaEdgePadding=function(t){return arguments.length?(e.rnaEdgePadding=t,r):e.rnaEdgePadding},r.nucleotideRadius=function(t){return arguments.length?(e.nucleotideRadius=t,r):e.nucleotideRadius},r.labelInterval=function(t){return arguments.length?(e.labelInterval=t,r):e.labelInterval},r.showNucleotideLabels=function(t){return arguments.length?(e.showNucleotideLabels=t,r):e.showNucleotideLabels},r.startNucleotideNumber=function(t){return arguments.length?(e.startNucleotideNumber=t,r):e.startNucleotideNumber},r.bundleExternalLinks=function(t){return arguments.length?(e.bundleExternalLinks=t,r):e.bundleExternalLinks},r.rnaLayout=function(t){return arguments.length?(e.rnaLayout=t,r):e.rnaLayout},r.namePosition=function(t){return arguments.length?(e.namePosition=t,r):e.namePosition},r.zoom=function(t){return arguments.length?(e.zoom=t,r):e.zoom},r}_.prototype.naview_xy_coordinates=function(t){var e,n=[],r=[];if(0===t.length||0===t[0])return 0;this.nbase=t[0],this.bases=[];for(var o=0;o<this.nbase+1;o++)this.bases.push(new A);this.regions=[];for(o=0;o<this.nbase+1;o++)this.regions.push(new w.a);this.read_in_bases(t),this.rlphead=null,this.find_regions(),this.loop_count=0,this.loops=[];for(o=0;o<this.nbase+1;o++)this.loops.push(new E.a);for(this.construct_loop(0),this.find_central_loop(),this.traverse_loop(this.root,null),e=0;e<this.nbase;e++)n.push(100+this.BACKBONE_DISTANCE*this.bases[e+1].getX()),r.push(100+this.BACKBONE_DISTANCE*this.bases[e+1].getY());return{nbase:this.nbase,x:n,y:r}},_.prototype.read_in_bases=function(t){var e=null,n=null;for(this.bases.push(new A),this.bases[0].setMate(0),this.bases[0].setExtracted(!1),this.bases[0].setX(this.ANUM),this.bases[0].setY(this.ANUM),n=0,e=1;e<=this.nbase;e++)this.bases.push(new A),this.bases[e].setExtracted(!1),this.bases[e].setX(this.ANUM),this.bases[e].setY(this.ANUM),this.bases[e].setMate(t[e]),t[e]>e&&n++;0==n&&(this.bases[1].setMate(this.nbase),this.bases[this.nbase].setMate(1))},_.prototype.find_regions=function(){var t,e=null,n=null;t=this.nbase+1;var r=[];for(e=0;e<t;e++)r.push(!1);for(this.nregion=0,e=0;e<=this.nbase;e++)if(0!=(n=this.bases[e].getMate())&&!r[e]){for(this.regions[this.nregion].setStart1(e),this.regions[this.nregion].setEnd2(n),r[e]=!0,r[n]=!0,this.bases[e].setRegion(this.regions[this.nregion]),this.bases[n].setRegion(this.regions[this.nregion]),e++,n--;e<n&&this.bases[e].getMate()==n;e++,n--)r[n]=!0,r[e]=!0,this.bases[e].setRegion(this.regions[this.nregion]),this.bases[n].setRegion(this.regions[this.nregion]);this.regions[this.nregion].setEnd1(--e),this.regions[this.nregion].setStart2(n+1),this.nregion++}},_.prototype.construct_loop=function(t){var e=null,n=null,r=new E.a,o=new E.a,i=new x.Connection,s=new w.a,a=new k;for((r=this.loops[this.loop_count++]).setNconnection(0),r.setDepth(0),r.setNumber(this.loop_count),r.setRadius(0),a=this.rlphead;null!=a;a=a.getNext())a.getLoopnumber()==this.loop_count&&r.setRadius(a.getRadius());e=t;do{0!=(n=this.bases[e].getMate())&&(s=this.bases[e].getRegion(),this.bases[s.getStart1()].isExtracted()||(e==s.getStart1()?(this.bases[s.getStart1()].setExtracted(!0),this.bases[s.getEnd1()].setExtracted(!0),this.bases[s.getStart2()].setExtracted(!0),this.bases[s.getEnd2()].setExtracted(!0),o=this.construct_loop(s.getEnd1()<this.nbase?s.getEnd1()+1:0)):e==s.getStart2()?(this.bases[s.getStart2()].setExtracted(!0),this.bases[s.getEnd2()].setExtracted(!0),this.bases[s.getStart1()].setExtracted(!0),this.bases[s.getEnd1()].setExtracted(!0),o=this.construct_loop(s.getEnd2()<this.nbase?s.getEnd2()+1:0)):console.log("Something went terribly wrong ...."),r.setNconnection(r.getNconnection()+1),i=new x.Connection,r.setConnection(r.getNconnection()-1,i),r.setConnection(r.getNconnection(),null),i.setLoop(o),i.setRegion(s),e==s.getStart1()?(i.setStart(s.getStart1()),i.setEnd(s.getEnd2())):(i.setStart(s.getStart2()),i.setEnd(s.getEnd1())),i.setExtruded(!1),i.setBroken(!1),o.setNconnection(o.getNconnection()+1),i=new x.Connection,o.setConnection(o.getNconnection()-1,i),o.setConnection(o.getNconnection(),null),i.setLoop(r),i.setRegion(s),e==s.getStart1()?(i.setStart(s.getStart2()),i.setEnd(s.getEnd1())):(i.setStart(s.getStart1()),i.setEnd(s.getEnd2())),i.setExtruded(!1),i.setBroken(!1)),e=n),++e>this.nbase&&(e=0)}while(e!=t);return r},_.prototype.find_central_loop=function(){var t=new E.a,e=null,n=null,r=null;for(function(){var t=new E.a,e=null,n=null;for(e=0;e<this.loop_count;e++){for(t=this.loops[e],n=0;n<this.loop_count;n++)this.loops[n].setMark(!1);t.setDepth(N(t))}}.bind(this)(),e=0,n=-1,r=0;r<this.loop_count;r++)(t=this.loops[r]).getNconnection()>e?(n=t.getDepth(),e=t.getNconnection(),this.root=t):t.getDepth()>n&&t.getNconnection()==e&&(n=t.getDepth(),this.root=t)},_.prototype.traverse_loop=function(t,e){var n,r,o,i,s,a,u,l,c,d,h,f,p,g,y,m,v,b,k,x,w,A,E,_,N,L,P,T,S,M,R,C,Y,I,B,O,U,X,D,q,z,F,V,j,J,H,W,G,K,Z,Q,$,tt,et,nt,rt,ot,it,st,at,ut,lt,ct,dt,ht,ft,pt,gt,yt,mt=0;a=2*Math.PI/(this.nbase+1),b=null,M=-1;var vt=0;for(E=0;null!=(m=t.getConnection(vt));vt++,E++)n=-Math.sin(a*m.getStart()),r=Math.cos(a*m.getStart()),o=-Math.sin(a*m.getEnd()),i=Math.cos(a*m.getEnd())-r,s=n-o,u=Math.sqrt(i*i+s*s),m.setXrad(i/u),m.setYrad(s/u),m.setAngle(Math.atan2(s,i)),m.getAngle()<0&&m.setAngle(m.getAngle()+2*Math.PI),null!=e&&e.getRegion()==m.getRegion()&&(b=m,M=E);t:for(;;){this.determine_radius(t,this.lencut),l=t.getRadius()/this.RADIUS_REDUCTION_FACTOR,null==e?c=d=0:(h=(this.bases[b.getStart()].getX()+this.bases[b.getEnd()].getX())/2,f=(this.bases[b.getStart()].getY()+this.bases[b.getEnd()].getY())/2,c=h-l*b.getXrad(),d=f-l*b.getYrad()),P=-1==M?0:M,m=t.getConnection(P),L=0,R=!1;do{if((w=P-1)<0&&(w=t.getNconnection()-1),k=t.getConnection(w),this.connected_connection(k,m)?(P=w,m=k):R=!0,++L>t.getNconnection()){for(N=-1,E=0;E<t.getNconnection();E++)(w=E+1)>=t.getNconnection()&&(w=0),m=t.getConnection(E),(ht=(v=t.getConnection(w)).getAngle()-m.getAngle())<0&&(ht+=2*Math.PI),ht>N&&(N=ht,mt=E);T=mt,(P=mt+1)>=t.getNconnection()&&(P=0),(m=t.getConnection(T)).setBroken(!0),R=!0}}while(!R);for(C=!1,H=P;!C;){for(L=0,R=!1,T=P,Y=!1;!R;)if(m=t.getConnection(T),T==M&&(Y=!0),(w=T+1)>=t.getNconnection()&&(w=0),v=t.getConnection(w),this.connected_connection(m,v)){if(++L>=t.getNconnection())break;T=w}else R=!0;for(E=W=G=S=this.find_ic_middle(P,T,e,b,t),R=!1,Z=0;!R;)(E=Z<0?W:0==Z?S:G)>=0&&(m=t.getConnection(E),null!=e&&b==m||(0==Z?(p=m.getAngle()-Math.asin(.5/l),g=m.getAngle()+Math.asin(.5/l),this.bases[m.getStart()].setX(c+l*Math.cos(p)),this.bases[m.getStart()].setY(d+l*Math.sin(p)),this.bases[m.getEnd()].setX(c+l*Math.cos(g)),this.bases[m.getEnd()].setY(d+l*Math.sin(g))):Z<0?((w=E+1)>=t.getNconnection()&&(w=0),m=t.getConnection(E),v=t.getConnection(w),nt=m.getXrad(),rt=m.getYrad(),ht=(m.getAngle()+v.getAngle())/2,m.getAngle()>v.getAngle()&&(ht-=Math.PI),st=Math.cos(ht),lt=Math.sin(ht),ct=-st,(_=v.getAngle()-m.getAngle())<0&&(_+=2*Math.PI),dt=m.isExtruded()?_<=Math.PI/2?2:1.5:1,this.bases[m.getEnd()].setX(this.bases[v.getStart()].getX()+dt*lt),this.bases[m.getEnd()].setY(this.bases[v.getStart()].getY()+dt*ct),this.bases[m.getStart()].setX(this.bases[m.getEnd()].getX()+rt),this.bases[m.getStart()].setY(this.bases[m.getEnd()].getY()-nt)):((w=E-1)<0&&(w=t.getNconnection()-1),m=t.getConnection(w),ot=(v=t.getConnection(E)).getXrad(),it=v.getYrad(),ht=(m.getAngle()+v.getAngle())/2,m.getAngle()>v.getAngle()&&(ht-=Math.PI),st=Math.cos(ht),lt=-Math.sin(ht),ct=st,(_=v.getAngle()-m.getAngle())<0&&(_+=2*Math.PI),dt=m.isExtruded()?_<=Math.PI/2?2:1.5:1,this.bases[v.getStart()].setX(this.bases[m.getEnd()].getX()+dt*lt),this.bases[v.getStart()].setY(this.bases[m.getEnd()].getY()+dt*ct),this.bases[v.getEnd()].setX(this.bases[v.getStart()].getX()-it),this.bases[v.getEnd()].setY(this.bases[v.getStart()].getY()+ot)))),Z<0?(G==T?G=-1:G>=0&&++G>=t.getNconnection()&&(G=0),Z=1):(W==P?W=-1:W>=0&&--W<0&&(W=t.getNconnection()-1),Z=-1),R=-1==W&&-1==G;if((K=T+1)>=t.getNconnection()&&(K=0),T!=P&&(P!=H||K!=H))if(m=t.getConnection(P),v=t.getConnection(T),$=this.bases[v.getEnd()].getX()-this.bases[m.getStart()].getX(),tt=this.bases[v.getEnd()].getY()-this.bases[m.getStart()].getY(),B=this.bases[m.getStart()].getX()+$/2,O=this.bases[m.getStart()].getY()+tt/2,D=$/(et=Math.sqrt($*$+tt*tt)),q=tt/et,z=c-B,F=d-O,U=(V=(z/=et=Math.sqrt($*$+tt*tt))*D+(F/=et)*q)*D-z,X=V*q-F,U/=et=Math.sqrt(U*U+X*X),X/=et,$=this.bases[m.getStart()].getX()-c,tt=this.bases[m.getStart()].getY()-d,(ht=Math.atan2(tt,$))<0&&(ht+=2*Math.PI),$=this.bases[v.getEnd()].getX()-c,tt=this.bases[v.getEnd()].getY()-d,(ft=Math.atan2(tt,$))<0&&(ft+=2*Math.PI),ft<ht&&(ft+=2*Math.PI),j=c+(I=ft-ht>Math.PI?-1:1)*l*U,J=d+I*l*X,Y)c-=j-B,d-=J-O;else for(E=P;x=(m=t.getConnection(E)).getStart(),this.bases[x].setX(this.bases[x].getX()+j-B),this.bases[x].setY(this.bases[x].getY()+J-O),x=m.getEnd(),this.bases[x].setX(this.bases[x].getX()+j-B),this.bases[x].setY(this.bases[x].getY()+J-O),E!=T;)++E>=t.getNconnection()&&(E=0);C=(P=K)==H}for(E=0;E<t.getNconnection();E++){if(m=t.getConnection(E),(w=E+1)>=t.getNconnection()&&(w=0),v=t.getConnection(w),$=this.bases[m.getEnd()].getX()-c,tt=this.bases[m.getEnd()].getY()-d,ut=Math.sqrt($*$+tt*tt),(ht=Math.atan2(tt,$))<0&&(ht+=2*Math.PI),$=this.bases[v.getStart()].getX()-c,tt=this.bases[v.getStart()].getY()-d,at=Math.sqrt($*$+tt*tt),(ft=Math.atan2(tt,$))<0&&(ft+=2*Math.PI),ft<ht&&(ft+=2*Math.PI),Q=ft-ht,(yt=v.getAngle()-m.getAngle())<=0&&(yt+=2*Math.PI),Math.abs(Q-yt)>Math.PI)if(m.isExtruded())console.log("Warning from traverse_loop. Loop "+t.getNumber()+" has crossed regions\n");else if(v.getStart()-m.getEnd()!=1){m.setExtruded(!0);continue t}if(m.isExtruded())this.construct_extruded_segment(m,v);else for((A=v.getStart()-m.getEnd())<0&&(A+=this.nbase+1),a=Q/A,w=1;w<A;w++)(x=m.getEnd()+w)>this.nbase&&(x-=this.nbase+1),et=ut+(at-ut)*((y=ht+w*a)-ht)/Q,this.bases[x].setX(c+et*Math.cos(y)),this.bases[x].setY(d+et*Math.sin(y))}break}for(E=0;E<t.getNconnection();E++)M!=E&&(m=t.getConnection(E),this.generate_region(m),this.traverse_loop(m.getLoop(),m));for(A=0,pt=0,gt=0,E=0;E<t.getNconnection();E++)if((w=E+1)>=t.getNconnection()&&(w=0),m=t.getConnection(E),v=t.getConnection(w),A+=2,pt+=this.bases[m.getStart()].getX()+this.bases[m.getEnd()].getX(),gt+=this.bases[m.getStart()].getY()+this.bases[m.getEnd()].getY(),!m.isExtruded())for(w=m.getEnd()+1;w!=v.getStart();w++)w>this.nbase&&(w-=this.nbase+1),A++,pt+=this.bases[w].getX(),gt+=this.bases[w].getY();t.setX(pt/A),t.setY(gt/A)},_.prototype.determine_radius=function(t,e){var n,r,o,i,s,a,u,l,c,d,h,f=0,p=new x.Connection,g=new x.Connection;do{for(n=1e10,s=0,i=0,l=0;l<t.getNconnection();l++)p=t.getConnection(l),(c=l+1)>=t.getNconnection()&&(c=0),g=t.getConnection(c),d=p.getEnd(),(h=g.getStart())<d&&(h+=this.nbase+1),(o=g.getAngle()-p.getAngle())<=0&&(o+=2*Math.PI),i+=o*(1/(r=p.isExtruded()?o<=Math.PI/2?2:1.5:h-d)+1),s+=o*o/r,(u=o/r)<n&&!p.isExtruded()&&r>1&&(n=u,f=l);(a=i/s)<.7071068&&(a=.7071068),n*a<e&&t.getConnection(f).setExtruded(!0)}while(n*a<e);t.getRadius()>0?a=t.getRadius():t.setRadius(a)},_.prototype.find_ic_middle=function(t,e,n,r,o){var i,s,a,u,l;for(i=0,s=-1,a=t,l=!1;!l;)i++>2*o.getNconnection()&&console.log("Infinite loop in 'find_ic_middle'"),null!=n&&o.getConnection(a)==r&&(s=a),l=a==e,++a>=o.getNconnection()&&(a=0);if(-1==s){for(u=1,a=t;u<(i+1)/2;u++)++a>=o.getNconnection()&&(a=0);s=a}return s},_.prototype.construct_extruded_segment=function(t,e){var n,r,o,i,s,a,u,l,c,d,h,f,p,g,y,m,v,b;if(n=t.getAngle(),(o=r=e.getAngle())<n&&(o+=2*Math.PI),i=(n+o)/2,p=t.getEnd(),(y=(g=e.getStart())-p)<0&&(y+=this.nbase+1),(h=e.getAngle()-t.getAngle())<0&&(h+=2*Math.PI),2==y)this.construct_circle_segment(p,g);else{s=this.bases[g].getX()-this.bases[p].getX(),a=this.bases[g].getY()-this.bases[p].getY(),s/=d=Math.sqrt(s*s+a*a),a/=d,d>=1.5&&h<=Math.PI/2&&((m=p+1)>this.nbase&&(m-=this.nbase+1),(v=g-1)<0&&(v+=this.nbase+1),this.bases[m].setX(this.bases[p].getX()+.5*s),this.bases[m].setY(this.bases[p].getY()+.5*a),this.bases[v].setX(this.bases[g].getX()-.5*s),this.bases[v].setY(this.bases[g].getY()-.5*a),p=m,g=v);do{b=!1,this.construct_circle_segment(p,g),(m=p+1)>this.nbase&&(m-=this.nbase+1),s=this.bases[m].getX()-this.bases[p].getX(),a=this.bases[m].getY()-this.bases[p].getY(),(u=Math.atan2(a,s))<0&&(u+=2*Math.PI),(f=u-n)<0&&(f+=2*Math.PI),f>Math.PI&&(b=!0),(v=g-1)<0&&(v+=this.nbase+1),s=this.bases[v].getX()-this.bases[g].getX(),a=this.bases[v].getY()-this.bases[g].getY(),(l=Math.atan2(a,s))<0&&(l+=2*Math.PI),(f=r-l)<0&&(f+=2*Math.PI),f>Math.PI&&(b=!0),b&&(c=this.minf2(i,n+.5),this.bases[m].setX(this.bases[p].getX()+Math.cos(c)),this.bases[m].setY(this.bases[p].getY()+Math.sin(c)),p=m,c=this.maxf2(i,o-.5),this.bases[v].setX(this.bases[g].getX()+Math.cos(c)),this.bases[v].setY(this.bases[g].getY()+Math.sin(c)),g=v,y-=2)}while(b&&y>1)}},_.prototype.construct_circle_segment=function(t,e){var n,r,o,i,s,a,u,l,c,d,h,f,p,g,y;if(n=this.bases[e].getX()-this.bases[t].getX(),r=this.bases[e].getY()-this.bases[t].getY(),o=Math.sqrt(n*n+r*r),(p=e-t)<0&&(p+=this.nbase+1),o>=p)for(n/=o,r/=o,g=1;g<p;g++)(y=t+g)>this.nbase&&(y-=this.nbase+1),this.bases[y].setX(this.bases[t].getX()+n*g/p),this.bases[y].setY(this.bases[t].getY()+r*g/p);else for(this.find_center_for_arc(p-1,o),n/=o,r/=o,i=this.bases[t].getX()+n*o/2,s=this.bases[t].getY()+r*o/2,a=r,u=-n,l=i+this._h*a,c=s+this._h*u,d=this.bases[t].getX()-l,h=this.bases[t].getY()-c,o=Math.sqrt(d*d+h*h),f=Math.atan2(h,d),g=1;g<p;g++)(y=t+g)>this.nbase&&(y-=this.nbase+1),this.bases[y].setX(l+o*Math.cos(f+g*this.angleinc)),this.bases[y].setY(c+o*Math.sin(f+g*this.angleinc))},_.prototype.find_center_for_arc=function(t,e){var n,r,o,i,s,a,u,l;o=-(r=(t+1)/Math.PI)-e/(t+1.000001-e),e<1&&(o=0),l=0;do{n=(r+o)/2,s=1-.5/((i=Math.sqrt(n*n+e*e/4))*i),Math.abs(s)>1&&console.log("Unexpected large magnitude discriminant = "+s+" "+i),(u=(a=Math.acos(s))*(t+1)+2*Math.acos(n/i)-2*Math.PI)>0?o=n:r=n}while(Math.abs(u)>1e-4&&++l<this.MAXITER);l>=this.MAXITER&&(noIterationFailureYet&&(console.log("Iteration failed in find_center_for_arc"),noIterationFailureYet=!1),n=0,a=0),this._h=n,this.angleinc=a},_.prototype.generate_region=function(t){var e,n,r,o,i,s;for(s=t.getRegion(),e=0,t.getStart()==s.getStart1()?(n=s.getStart1(),r=s.getEnd1()):(n=s.getStart2(),r=s.getEnd2()),(this.bases[t.getStart()].getX()>this.ANUM-100||this.bases[t.getEnd()].getX()>this.ANUM-100)&&console.log("Bad region passed to generate_region. Coordinates not defined."),o=n+1;o<=r;o++)e++,this.bases[o].setX(this.bases[t.getStart()].getX()+this.HELIX_FACTOR*e*t.getXrad()),this.bases[o].setY(this.bases[t.getStart()].getY()+this.HELIX_FACTOR*e*t.getYrad()),i=this.bases[o].getMate(),this.bases[i].setX(this.bases[t.getEnd()].getX()+this.HELIX_FACTOR*e*t.getXrad()),this.bases[i].setY(this.bases[t.getEnd()].getY()+this.HELIX_FACTOR*e*t.getYrad())},_.prototype.minf2=function(t,e){return t<e?t:e},_.prototype.maxf2=function(t,e){return t>e?t:e},_.prototype.connected_connection=function(t,e){return!!t.isExtruded()||t.getEnd()+1==e.getStart()},n.d(e,"FornaContainer",function(){return L}),n.d(e,"rnaPlot",function(){return P}),n.d(e,"rnaTreemap",function(){return T}),n.d(e,"RNAUtilities",function(){return p}),n.d(e,"ColorScheme",function(){return y})}])});
//# sourceMappingURL=fornac.js.map